importScripts("aes.js");importScripts("dext5upload.base64.js");importScripts("dext5upload.xhr.js");var numberOfServerUploadedChunks=0;
function buildFormData(b,g,f,e,d,m,h,k,q,t,r,l){var p=new FileReaderSync,c=p.readAsDataURL(b).match(/,(.*)$/)[1],v,n=function(){var a="";if("0"!=d.encryptParam){var b;b=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uploadRequest"+Dext5Base64._trans_unitDelimiter);b+="d18"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter;b+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter;b+="d08"+Dext5Base64._trans_unitAttributeDelimiter+e+Dext5Base64._trans_unitDelimiter;
b+="d12"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter;b+="d38"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter;b+="d11"+Dext5Base64._trans_unitAttributeDelimiter+d.folderNameRule+Dext5Base64._trans_unitDelimiter;b+="d09"+Dext5Base64._trans_unitAttributeDelimiter+d.fileNameRule+Dext5Base64._trans_unitDelimiter;b+="d10"+Dext5Base64._trans_unitAttributeDelimiter+d.fileNameRuleEx+Dext5Base64._trans_unitDelimiter;b+="d35"+Dext5Base64._trans_unitAttributeDelimiter+
d.checkFileExtension+Dext5Base64._trans_unitDelimiter;b+="d37"+Dext5Base64._trans_unitAttributeDelimiter+d.uploadChunkSize+Dext5Base64._trans_unitDelimiter;b+="d47"+Dext5Base64._trans_unitAttributeDelimiter+h+Dext5Base64._trans_unitDelimiter;0<d.encryptFile&&(b+="d17"+Dext5Base64._trans_unitAttributeDelimiter+d.encryptFile+Dext5Base64._trans_unitDelimiter);b=Dext5Base64.makeEncryptParamFinal(d.encryptParam,b);a+="--"+m+'\r\nContent-Disposition: form-data; name="'+b.name+'"';a+="\r\n\r\n";a+=b.value;
a+="\r\n"}else a+="--"+m+'\r\nContent-Disposition: form-data; name="dext5CMD"',a+="\r\n",a+="\r\n",a+="uploadRequest",a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="chunkNumber"',a+="\r\n",a+="\r\n",a+=g,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="GUID"',a+="\r\n",a+="\r\n",a+=f,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileName"',a+="\r\n",a+="\r\n",a+=e,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="gpid"',a+="\r\n",a+="\r\n",
a+=q,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fidx"',a+="\r\n",a+="\r\n",a+=t,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="folderNameRule"',a+="\r\n",a+="\r\n",a+=d.folderNameRule,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileNameRule"',a+="\r\n",a+="\r\n",a+=d.fileNameRule,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileNameRuleEx"',a+="\r\n",a+="\r\n",a+=d.fileNameRuleEx,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="cfe"',
a+="\r\n",a+="\r\n",a+=d.checkFileExtension,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="cs"',a+="\r\n",a+="\r\n",a+=d.uploadChunkSize,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fs"',a+="\r\n",a+="\r\n",a+=h,a+="\r\n",0<d.encryptFile&&(a+="--"+m+'\r\nContent-Disposition: form-data; name="fde"',a+="\r\n",a+="\r\n",a+=d.encryptFile,a+="\r\n");a+="--"+m+'\r\nContent-Disposition: form-data; name="mark"';a+="\r\n";a+="\r\n";a+=k;a+="\r\n";b=r.length;for(var n=0;n<
b;n++)a+="--"+m+'\r\nContent-Disposition: form-data; name="'+r[n].form_name+'"',a+="\r\n",a+="\r\n",a+=r[n].form_value,a+="\r\n";a+="--"+m+'\r\nContent-Disposition: form-data; name="Slice"; filename="blob"';a+="\r\n";a+="Content-Type: application/octet-stream; charset=UTF-8";a+="\r\n";a+="\r\n";a+=c+"\r\n";a+="--"+m+"--\r\n";p=null;l(a)},w=function(a){c=p.readAsDataURL(a).match(/,(.*)$/)[1];n()};0<d.encryptFile?(v||(v=p.readAsArrayBuffer(b)),encryptFileData(v,d.ServerReleaseVer.substring(0,11),16*
d.encryptFile,w)):n()}function makeGuidTagName(b){var g=0,f=(new Date).getTime().toString(32),e;for(e=0;5>e;e++)f+=Math.floor(65535*Math.random()).toString(32);return(b||"o_")+f+(g++).toString(32)}
function upload_merge(b,g,f,e,d,m,h,k,q,t,r){var l=XHRFactory.getInstance();l.open("POST",d,m);l.onreadystatechange=function(c){if(4==l.readyState)if(200==l.status){var e=l.responseText;c=e.split("|");1==c.length&&(c=Dext5Base64.makeDecryptReponseMessageEx2(e),e="success"==c.result?c.value:"error"==c.result?c.value:""==h.ServerReleaseVer||"2.7.1120889.1613.01">=h.ServerReleaseVer?Dext5Base64.decode(e):Dext5Base64.makeDecryptReponseMessage(e),c=e.split("|"));if(0==e.indexOf("error"))self.postMessage({type:"error",
code:c[1],message:c[2],id:b}),XHRFactory.release(l),self.close();else{var d;d=c[0];var f=d.indexOf("::");-1<f?(e=d.substring(0,f),d=d.substring(f+2)):(e=g,d=c[0]);2==c.length?-1<c[1].indexOf("\b")?self.postMessage({type:"complete",id:b,originalFileName:e,uploadFilePath:d,uploadFileName:c[1].split("\b")[0],uploadCustomValue:"",uploadGroupId:c[1].split("\b")[1]}):self.postMessage({type:"complete",id:b,originalFileName:e,uploadFilePath:d,uploadFileName:c[1],uploadCustomValue:"",uploadGroupId:""}):3==
c.length&&(-1<c[2].indexOf("\b")?self.postMessage({type:"complete",id:b,originalFileName:e,uploadFilePath:d,uploadFileName:c[1],uploadCustomValue:c[2].split("\b")[0],uploadGroupId:c[2].split("\b")[1]}):self.postMessage({type:"complete",id:b,originalFileName:e,uploadFilePath:d,uploadFileName:c[1],uploadCustomValue:c[2],uploadGroupId:""}));XHRFactory.release(l)}}else if(400<=l.status&&600>l.status||0==l.status)self.postMessage({type:"error",code:"200004",message:"Http Status Code "+l.status,id:b}),
XHRFactory.release(l),self.close()};"0"!=h.encryptParam?(d=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"mergeRequest"+Dext5Base64._trans_unitDelimiter),d+="d08"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter,d+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter,d+="d19"+Dext5Base64._trans_unitAttributeDelimiter+e.numberOfChunks+Dext5Base64._trans_unitDelimiter,d+="d12"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter,
d+="d38"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter,d+="d11"+Dext5Base64._trans_unitAttributeDelimiter+h.folderNameRule+Dext5Base64._trans_unitDelimiter,d+="d09"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRule+Dext5Base64._trans_unitDelimiter,d+="d10"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,f=Dext5Base64.makeEncryptParamFinal(h.encryptParam,d),f=f.name+"="+f.value):(f="dext5CMD=mergeRequest&fileName="+g+
"&GUID="+f+"&numberOfChunks="+e.numberOfChunks+"&gpid="+q+"&fidx="+t,f+="&folderNameRule="+h.folderNameRule+"&fileNameRule="+h.fileNameRule+"&fileNameRuleEx="+h.fileNameRuleEx,0<h.encryptFile&&(f+="&fde="+h.encryptFile));"1"==h.integrity&&(f+="&fdi="+h.FDIData);f+="&mark="+k;k=r.length;for(e=0;e<k;e++)f+="&"+r[e].form_name+"="+r[e].form_value;l.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");try{l.send(f)}catch(p){self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",
id:b}),XHRFactory.release(l),self.close()}}
function upload(b,g,f,e,d,m,h,k,q,t,r,l){var p=XHRFactory.getInstance(),c=f,c=-1<c.indexOf("?")?c+"&dext=slice":c+"?dext=slice",c=c+("&p="+makeGuidTagName("urk_"));p.open("POST",c,d);var v=b.size;p.onreadystatechange=function(){if(4==p.readyState)if(200==p.status){var a=p.responseText,b=a.split("|");1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(a),a="success"==b.result?b.value:"error"==b.result?b.value:""==k.ServerReleaseVer||"2.7.1120889.1613.01">=k.ServerReleaseVer?Dext5Base64.decode(a):
Dext5Base64.makeDecryptReponseMessage(a),b=a.split("|"));0==a.indexOf("error")?(self.postMessage({type:"error",code:b[1],message:b[2],id:m}),XHRFactory.release(p),self.close()):""!=p.responseText.replace(/ /g,"")?(self.postMessage({type:"error",code:"200018",message:"",id:m}),XHRFactory.release(p),self.close()):(numberOfServerUploadedChunks++,self.postMessage({type:"progress",uploadedChunks:numberOfServerUploadedChunks,uploadedSize:v,chunkInfo:e,id:m}),numberOfServerUploadedChunks==e.numberOfChunks&&
(upload_merge(m,g,h,e,f,d,k,q,t,r,l),numberOfServerUploadedChunks=0),XHRFactory.release(p))}else if(400<=p.status&&600>p.status||0==p.status)self.postMessage({type:"error",code:"200004",message:"Http Status Code "+p.status,id:m}),XHRFactory.release(p),self.close()};var n="",w=function(){try{p.send(n)}catch(a){self.postMessage({type:"reupload",chunk:b,filename:g,chunkInfo:e,asyncstate:d,guid:h,configValues:k,id:m,mark:q,gpid:t,fidx:r}),XHRFactory.release(p)}n=b=null};if("undefined"==typeof FormData){var a=
makeGuidTagName("----dext5_"),c=function(b){n=b;p.setRequestHeader("Content-Type","multipart/form-data; boundary="+a);p.setRequestHeader("Dext5-Encoded","base64");w()};try{buildFormData(b,e.currentNumber,h,g,k,a,e.size,q,t,r,l,c)}catch(y){self.postMessage({type:"reupload",chunk:b,filename:g,chunkInfo:e,asyncstate:d,guid:h,configValues:k,id:m,mark:q,gpid:t,fidx:r})}}else{n=new FormData;"0"!=k.encryptParam?(c=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uploadRequest"+Dext5Base64._trans_unitDelimiter),
c+="d18"+Dext5Base64._trans_unitAttributeDelimiter+e.currentNumber+Dext5Base64._trans_unitDelimiter,c+="d07"+Dext5Base64._trans_unitAttributeDelimiter+h+Dext5Base64._trans_unitDelimiter,c+="d08"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter,c+="d12"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter,c+="d38"+Dext5Base64._trans_unitAttributeDelimiter+r+Dext5Base64._trans_unitDelimiter,c+="d11"+Dext5Base64._trans_unitAttributeDelimiter+k.folderNameRule+
Dext5Base64._trans_unitDelimiter,c+="d09"+Dext5Base64._trans_unitAttributeDelimiter+k.fileNameRule+Dext5Base64._trans_unitDelimiter,c+="d10"+Dext5Base64._trans_unitAttributeDelimiter+k.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,c+="d35"+Dext5Base64._trans_unitAttributeDelimiter+k.checkFileExtension+Dext5Base64._trans_unitDelimiter,c+="d37"+Dext5Base64._trans_unitAttributeDelimiter+k.uploadChunkSize+Dext5Base64._trans_unitDelimiter,c+="d47"+Dext5Base64._trans_unitAttributeDelimiter+e.size+Dext5Base64._trans_unitDelimiter,
0<k.encryptFile&&(c+="d17"+Dext5Base64._trans_unitAttributeDelimiter+k.encryptFile+Dext5Base64._trans_unitDelimiter),c=Dext5Base64.makeEncryptParamFinal(k.encryptParam,c),n.append(c.name,c.value)):(n.append("dext5CMD","uploadRequest"),n.append("chunkNumber",e.currentNumber),n.append("GUID",h),n.append("fileName",g),n.append("gpid",t),n.append("fidx",r),n.append("folderNameRule",k.folderNameRule),n.append("fileNameRule",k.fileNameRule),n.append("fileNameRuleEx",k.fileNameRuleEx),n.append("cfe",k.checkFileExtension),
n.append("cs",k.uploadChunkSize),n.append("fs",e.size),0<k.encryptFile&&n.append("fde",k.encryptFile));n.append("mark",q);for(var c=l.length,u=0;u<c;u++)n.append(l[u].form_name,l[u].form_value);c=function(a){n.append("Slice",a);w()};if(0<k.encryptFile){var u=new FileReaderSync,x=null;try{x=u.readAsArrayBuffer(b),encryptFileData(x,k.ServerReleaseVer.substring(0,11),16*k.encryptFile,c),u=null}catch(z){u=null,self.postMessage({type:"error",code:"200004",message:"Http Status Code "+p.status,id:m}),XHRFactory.release(p),
self.close()}}else n.append("Slice",b),w()}}
function uploadZeroFile(b,g,f,e,d,m,h,k,q,t,r){var l=XHRFactory.getInstance();l.open("POST",e,d);l.onreadystatechange=function(c){if(4==l.readyState)if(200==l.status){var e=l.responseText;c=e.split("|");1==c.length&&(c=Dext5Base64.makeDecryptReponseMessageEx2(e),e="success"==c.result?c.value:"error"==c.result?c.value:""==h.ServerReleaseVer||"2.7.1120889.1613.01">=h.ServerReleaseVer?Dext5Base64.decode(e):Dext5Base64.makeDecryptReponseMessage(e),c=e.split("|"));if(0==e.indexOf("error"))self.postMessage({type:"error",
code:c[1],message:c[2],id:b}),XHRFactory.release(l),self.close();else{var d;d=c[0];var f=d.indexOf("::");-1<f?(e=d.substring(0,f),d=d.substring(f+2)):(e=g,d=c[0]);2==c.length?-1<c[1].indexOf("\b")?self.postMessage({type:"complete",id:b,originalFileName:e,uploadFilePath:d,uploadFileName:c[1].split("\b")[0],uploadCustomValue:"",uploadGroupId:c[1].split("\b")[1]}):self.postMessage({type:"complete",id:b,originalFileName:e,uploadFilePath:d,uploadFileName:c[1],uploadCustomValue:"",uploadGroupId:""}):3==
c.length&&(-1<c[2].indexOf("\b")?self.postMessage({type:"complete",id:b,originalFileName:e,uploadFilePath:d,uploadFileName:c[1],uploadCustomValue:c[2].split("\b")[0],uploadGroupId:c[2].split("\b")[1]}):self.postMessage({type:"complete",id:b,originalFileName:e,uploadFilePath:d,uploadFileName:c[1],uploadCustomValue:c[2],uploadGroupId:""}));XHRFactory.release(l)}}else if(400<=l.status&&600>l.status||0==l.status)self.postMessage({type:"error",code:"200004",message:"Http Status Code "+l.status,id:b}),
XHRFactory.release(l),self.close()};"0"!=h.encryptParam?(e=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uzr"+Dext5Base64._trans_unitDelimiter),e+="d08"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter,e+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter,e+="d12"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter,e+="d38"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter,e+="d11"+
Dext5Base64._trans_unitAttributeDelimiter+h.folderNameRule+Dext5Base64._trans_unitDelimiter,e+="d09"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRule+Dext5Base64._trans_unitDelimiter,e+="d10"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,e+="d35"+Dext5Base64._trans_unitAttributeDelimiter+h.checkFileExtension+Dext5Base64._trans_unitDelimiter,f=Dext5Base64.makeEncryptParamFinal(h.encryptParam,e),f=f.name+"="+f.value):(f="dext5CMD=uzr&fileName="+
g+"&GUID="+f+"&gpid="+q+"&fidx="+t+("&folderNameRule="+h.folderNameRule+"&fileNameRule="+h.fileNameRule+"&fileNameRuleEx="+h.fileNameRuleEx),f+="&cfe="+h.checkFileExtension);f+="&mark="+k;k=r.length;for(q=0;q<k;q++)f+="&"+r[q].form_name+"="+r[q].form_value;l.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");try{l.send(f)}catch(p){self.postMessage({type:"error",code:"000",message:"Upload Error: uploadZeroFile",id:b}),XHRFactory.release(l),XHRFactory=null,self.close()}}
self.onmessage=function(b){b=b.data;switch(b.type){case "upload":upload(b.chunk,b.filename,b.handlerurl,b.chunkInfo,b.asyncstate,b.id,b.guid,b.configValues,b.mark,b.gpid,b.fidx,b.formDataEx);break;case "uploadZeroFile":self.postMessage({type:"progress",uploadedChunks:1,uploadedSize:0,chunkInfo:{currentNumber:1,numberOfChunks:1,size:0},id:b.id}),uploadZeroFile(b.id,b.filename,b.guid,b.handlerurl,b.asyncstate,b.blob,b.configValues,b.mark,b.gpid,b.fidx,b.formDataEx)}};
function encryptFileData(b,g,f,e){var d;try{d=crypto||msCrypto}catch(m){}if(d&&d.subtle){var h=stringToBytes(g);g=new Uint8Array(f);g.set(h);var k=d.subtle.importKey("raw",g,{name:"AES-CBC"},!1,["encrypt","decrypt"]);k.then(function(f){var g=new Uint8Array(16);g.set(h);d.subtle.encrypt({name:"AES-CBC",iv:g},f,b).then(function(b){b=makeBlob(b);e(b)})["catch"]=function(b){self.postMessage({type:"error",code:"C011",message:b.message||b,workerId:workerData.workerId})}})["catch"]=function(b){self.postMessage({type:"error",
code:"C011",message:b.message||b,workerId:workerData.workerId})}}else k=CryptoJS.enc.Utf8.parse(g),k.sigBytes=f,wordArrayData=function(b){b=new Uint8Array(b);for(var e=[],d=0;d<b.length;d+=4)e.push(b[d]<<24|b[d+1]<<16|b[d+2]<<8|b[d+3]);return CryptoJS.lib.WordArray.create(e,b.length)}(b),g=CryptoJS.AES.encrypt(wordArrayData,k,{iv:CryptoJS.enc.Utf8.parse(g)}),wordArrayData=void 0,g=makeBlob(function(b){var e=b.words.length,d=new Uint8Array(e<<2),f=0,g,c;for(c=0;c<e;c++)g=b.words[c],d[f++]=g>>24,d[f++]=
g>>16&255,d[f++]=g>>8&255,d[f++]=g&255;return d}(g.ciphertext)),e(g)}function arrayBufferToBase64(b){var g="";b=new Uint8Array(b);for(var f=b.byteLength,e=0;e<f;e++)g+=String.fromCharCode(b[e]);return btoa(g)}function stringToBytes(b){for(var g,f,e=[],d=0;d<b.length;d++){g=b.charCodeAt(d);f=[];do f.push(g&255),g>>=8;while(g);e=e.concat(f.reverse())}return e}var makeBlob=function(b){var g=[];g.push(b);return new Blob(g,{type:"application/octet-stream"})};
