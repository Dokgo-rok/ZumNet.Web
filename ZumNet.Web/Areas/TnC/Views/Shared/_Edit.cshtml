@using System.Data;
@using System.Text;
@using System.Threading;

@using Newtonsoft.Json;
@using Newtonsoft.Json.Linq;

@using ZumNet.Framework.Util;
@using ZumNet.Web.Bc;
@{
    JObject jApp = ViewBag.R.app;

    DateTime dtStart = Convert.ToDateTime(jApp["periodfrom"].ToString() + " " + jApp["start"].ToString());
    DateTime dtEnd = Convert.ToDateTime(jApp["periodto"].ToString() + " " + jApp["end"].ToString());
    string sRptDayMargin = Thread.CurrentThread.CurrentUICulture.Name.Substring(0, 2) == "en" ? "ml-1" : "ml-2";

    bool bEditable = false;
    if (Session["URID"].ToString() == jApp["creurid"].ToString() || ViewBag.R.current["operator"].ToString() == "Y"
        || StringHelper.HasAcl(ViewBag.R.current["appacl"].ToString(), "R"))
    {
        bEditable = true;
    }
}
@functions{
    private string GetStateIcon(string approval, string confirmed, string state)
    {
        if (approval == "Y")
        {
            if (confirmed == "Y")
            {
                if (state == "7") return "<a class=\"btn btn-sm rounded-pill btn-outline-success ml-2\" title=\"사용 가능\"><i class=\"far fa-calendar-check mr-2\"></i>승인</a>";
                else if (state == "6") return "<a class=\"btn btn-sm rounded-pill btn-outline-waning ml-2\" title=\"사용 보류\"><i class=\"far fa-calendar-minus mr-2\"></i>보류</a>";
                else return "<a class=\"btn btn-sm rounded-pill btn-outline-danger ml-2\" title=\"사용 불가\"><i class=\"far fa-calendar-times mr-2\"></i>불가</a>";
            }
            else return "<a class=\"btn btn-sm rounded-pill btn-outline-secondary ml-2\" title=\"확인 요청중\"><i class=\"far fa-question-circle mr-2\"></i>대기</a>";
        }
        else
        {
            if (state == "7") return "<a class=\"btn btn-sm rounded-pill btn-outline-success ml-2\" title=\"사용 가능\"><i class=\"far fa-calendar-check mr-2\"></i>가능</a>";
            else return "<a class=\"btn btn-sm rounded-pill btn-outline-danger ml-2\" title=\"사용 불가\"><i class=\"far fa-calendar-times mr-2\"></i>불가</a>";
        }
    }

    private string RenderRepeat(JObject j)
    {
        string sRType = "0";
        string sInterval = "1"; //기본 1
        string sConDay = "";
        string sREnd = "";

        if (j != null)
        {
            sRType = Convert.ToInt16(j["repeat"]["type"]) > 2 ? (Convert.ToInt16(j["repeat"]["type"]) + 1).ToString() : j["repeat"]["type"].ToString().Trim();
            sInterval = j["repeat"]["interval"].ToString().Trim();
            sConDay = j["repeat"]["conday"].ToString().Trim();
            sREnd = j["repeat"]["end"].ToString().Trim();

            if (sRType == "2" && sConDay != "xooooox") sRType = "3";
        }
        if (sConDay == "") sConDay = "xxxxxxx";

        StringBuilder sb = new StringBuilder();
        sb.AppendFormat("<div class=\"form-group row mb-1 mb-sm-2{0}\" data-for=\"rpt-rule\">", sRType != "0" ? "" : " d-none");
        sb.Append("<label for=\"cbRepeatType\" class=\"col-sm-2 col-form-label font-weight-normal\">반복주기</label>");
        sb.Append("<div class=\"col-sm-10 form-inline align-items-center\">");
        sb.Append("<select class=\"custom-select mr-2\" id=\"cbRepeatType\" style=\"max-width:115px\">"); //반복종류
        sb.AppendFormat("<option value=\"1\"{0}>매일</option>", (sRType == "1") ? " selected" : "");
        sb.AppendFormat("<option value=\"2\"{0}>매주 월-금</option>", (sRType == "2") ? " selected" : "");
        sb.AppendFormat("<option value=\"3\"{0}>매주</option>", (sRType == "3") ? " selected" : "");
        sb.Append("</select>");
        sb.AppendFormat("<div class=\"{0} align-items-center\" id=\"sPerDay\">", sRType == "1" ? "d-flex" : "d-none");
        sb.AppendFormat("<input type=\"text\" class=\"form-control\" id=\"\" maxlength=\"2\" value=\"{0}\" style=\"max-width: 40px\" data-inputmask=\"number;1;\"><label class=\"mb-0 ml-1\">일마다</label>", sInterval); //매일
        sb.Append("<a href=\"javascript:\" class=\"btn btn-default ml-2\" data-val=\"2\">2일</a><a href=\"javascript:\" class=\"btn btn-default ml-2\" data-val=\"3\">3일</a>");
        sb.Append("</div>");
        sb.AppendFormat("<div class=\"{0} align-items-center\" id=\"sPerWeek\">", sRType != "1" ? "d-flex" : "d-none");
        sb.AppendFormat("<input type=\"text\" class=\"form-control\" id=\"\" maxlength=\"2\" value=\"{0}\" style=\"max-width: 40px\" data-inputmask=\"number;1;\"><label class=\"mb-0 ml-1\">주마다</label>", sInterval); //매일
        sb.Append("<a href=\"javascript:\" class=\"btn btn-default ml-2\" data-val=\"2\">2주</a><a href=\"javascript:\" class=\"btn btn-default ml-2\" data-val=\"3\">3주</a>");
        sb.Append("</div>");
        sb.Append("</div>");
        sb.Append("</div>"); //pRRule -> rpt-rule

        sb.AppendFormat("<div class=\"form-group row mb-2{0}\" data-for=\"rpt-day\">", sRType == "3" ? "" : " d-none");
        sb.Append("<label for=\"\" class=\"col-sm-2 col-form-label font-weight-normal\"></label>");
        sb.Append("<div class=\"col-sm-10 input-group align-items-center\">");
        sb.AppendFormat("<label class=\"custom-control custom-checkbox m-0\" for=\"ckb031\"><input class=\"custom-control-input\" id=\"ckb031\" name=\"ckbDay\" type=\"checkbox\" value=\"sun\"{0} /><span class=\"custom-control-label\">일</span></label>", (sConDay.Substring(0, 1) == "o") ? " checked" : "");
        sb.AppendFormat("<label class=\"custom-control custom-checkbox m-0 ml-2\" for=\"ckb032\"><input class=\"custom-control-input\" id=\"ckb032\" name=\"ckbDay\" type=\"checkbox\" value=\"mon\"{0} /><span class=\"custom-control-label\">월</span></label>", (sConDay.Substring(1, 1) == "o") ? " checked" : "");
        sb.AppendFormat("<label class=\"custom-control custom-checkbox m-0 ml-2\" for=\"ckb033\"><input class=\"custom-control-input\" id=\"ckb033\" name=\"ckbDay\" type=\"checkbox\" value=\"tue\"{0} /><span class=\"custom-control-label\">화</span></label>", (sConDay.Substring(2, 1) == "o") ? " checked" : "");
        sb.AppendFormat("<label class=\"custom-control custom-checkbox m-0 ml-2\" for=\"ckb034\"><input class=\"custom-control-input\" id=\"ckb034\" name=\"ckbDay\" type=\"checkbox\" value=\"wed\"{0} /><span class=\"custom-control-label\">수</span></label>", (sConDay.Substring(3, 1) == "o") ? " checked" : "");
        sb.AppendFormat("<label class=\"custom-control custom-checkbox m-0 ml-2\" for=\"ckb035\"><input class=\"custom-control-input\" id=\"ckb035\" name=\"ckbDay\" type=\"checkbox\" value=\"thu\"{0} /><span class=\"custom-control-label\">목</span></label>", (sConDay.Substring(4, 1) == "o") ? " checked" : "");
        sb.AppendFormat("<label class=\"custom-control custom-checkbox m-0 ml-2\" for=\"ckb036\"><input class=\"custom-control-input\" id=\"ckb036\" name=\"ckbDay\" type=\"checkbox\" value=\"fri\"{0} /><span class=\"custom-control-label\">금</span></label>", (sConDay.Substring(5, 1) == "o") ? " checked" : "");
        sb.AppendFormat("<label class=\"custom-control custom-checkbox m-0 ml-2\" for=\"ckb037\"><input class=\"custom-control-input\" id=\"ckb037\" name=\"ckbDay\" type=\"checkbox\" value=\"sat\"{0} /><span class=\"custom-control-label\">토</span></label>", (sConDay.Substring(6, 1) == "o") ? " checked" : "");
        sb.Append("</div>");
        sb.Append("</div>"); //pRRule -> rpt-day

        sb.AppendFormat("<div class=\"form-group row mb-2{0}\" data-for=\"rpt-end\">", sRType != "0" ? "" : " d-none");
        sb.Append("<label for=\"txtRepeatEnd\" class=\"col-sm-2 col-form-label font-weight-normal\">반복기간</label>");
        sb.Append("<div class=\"col-sm-10 input-group align-items-center\">");
        sb.AppendFormat("<input class=\"form-control datepicker\" id=\"txtRepeatEnd\" value=\"{0}\" type=\"text\"{1} style=\"max-width: 115px\"><label class=\"mb-0 ml-1\">까지</label>", sREnd, (sREnd == "") ? " disabled" : "");
        sb.Append("<label class=\"custom-control custom-checkbox m-0 ml-2\">");
        sb.AppendFormat("<input type=\"checkbox\" class=\"custom-control-input\" name=\"ckbRepeatEnd\" id=\"ckb04\"{0}>", (sREnd == "") ? " checked" : "");
        sb.Append("<span class=\"custom-control-label\">무한반복</span>");
        sb.Append("</label>");
        sb.Append("</div>");

        if (j != null)
        {
            //원 반복값
            sb.AppendFormat("<input type=\"hidden\" data-column=\"RepeatType\" value=\"{0}\" />", (sRType == "3") ? "2" : sRType);
            sb.AppendFormat("<input type=\"hidden\" data-column=\"Interval\" value=\"{0}\" />", sInterval);
            sb.AppendFormat("<input type=\"hidden\" data-column=\"ConDay\" value=\"{0}\" />", sConDay);
            sb.AppendFormat("<input type=\"hidden\" data-column=\"RepeatEnd\" value=\"{0}\" />", sREnd);
            sb.AppendFormat("<input type=\"hidden\" data-column=\"PeriodFrom\" value=\"{0}\" />", j["periodfrom"].ToString().Trim());
            sb.AppendFormat("<input type=\"hidden\" data-column=\"StartTime\" value=\"{0}\" />", j["start"].ToString().Trim());
            sb.AppendFormat("<input type=\"hidden\" data-column=\"EndTime\" value=\"{0}\" />", j["end"].ToString().Trim());
        }
        else
        {
            sb.Append("<input type=\"hidden\" data-column=\"RepeatType\" value=\"0\" />");
            sb.Append("<input type=\"hidden\" data-column=\"Interval\" value=\"\" />");
            sb.Append("<input type=\"hidden\" data-column=\"ConDay\" value=\"\" />");
            sb.Append("<input type=\"hidden\" data-column=\"RepeatEnd\" value=\"\" />");
            sb.Append("<input type=\"hidden\" data-column=\"PeriodFrom\" value=\"\" />");
            sb.Append("<input type=\"hidden\" data-column=\"StartTime\" value=\"\" />");
            sb.Append("<input type=\"hidden\" data-column=\"EndTime\" value=\"\" />");
        }
        sb.Append("</div>"); //pREnd -> rpt-end

        return sb.ToString();
    }

    private string GetRepeatDesc(JObject j)
    {
        JObject jRpt = (JObject)j["repeat"];

        string sStart = j["periodfrom"].ToString().Replace("-", ".") + "부터";
        if (jRpt["end"].ToString().Trim() != "") sStart += "&nbsp;" + jRpt["end"].ToString().Replace("-", ".") + "까지";

        string sInterval = (jRpt["interval"].ToString().Trim() == "1") ? "매" : jRpt["interval"].ToString();
        string sType = "";
        if (jRpt["type"].ToString() == "1") sType = "일";
        else if (jRpt["type"].ToString() == "2") sType = "주";
        else if (jRpt["type"].ToString() == "3") sType = "월";

        //xxxoxxx
        string sDay = (jRpt["conday"].ToString().Substring(0, 1) == "o") ? "일" : "";
        if (jRpt["conday"].ToString().Substring(1, 1) == "o")
        {
            if (sDay != "") sDay += ",";
            sDay += "월";
        }
        if (jRpt["conday"].ToString().Substring(2, 1) == "o")
        {
            if (sDay != "") sDay += ",";
            sDay += "화";
        }
        if (jRpt["conday"].ToString().Substring(3, 1) == "o")
        {
            if (sDay != "") sDay += ",";
            sDay += "수";
        }
        if (jRpt["conday"].ToString().Substring(4, 1) == "o")
        {
            if (sDay != "") sDay += ",";
            sDay += "목";
        }
        if (jRpt["conday"].ToString().Substring(5, 1) == "o")
        {
            if (sDay != "") sDay += ",";
            sDay += "금";
        }
        if (jRpt["conday"].ToString().Substring(6, 1) == "o")
        {
            if (sDay != "") sDay += ",";
            sDay += "토";
        }
        if (sDay.Length == 1) sDay += "요일";

        return sStart + "&nbsp;&nbsp;|&nbsp;&nbsp;" + sInterval + sType + "&nbsp;" + sDay + " 반복";
    }

    private string RenderFile(string mode, JArray file)
    {
        StringBuilder sb = new StringBuilder();

        sb.Append("<div class=\"zf-upload w-100\">");
        if (mode != "view")
        {
            sb.Append("<div class=\"zf-upload-select d-flex align-items-center\">");

            sb.Append("<form id=\"uploadForm\" name=\"uploadForm\" action=\"/Common/Upload\" method=\"post\" enctype=\"multipart/form-data\" target=\"ifrView\">");
            sb.Append("<div class=\"custom-file\">");
            sb.Append("<input type=\"file\" class=\"custom-file-input\" id=\"file1\" name=\"file1\" multiple />");
            sb.Append("<input name=\"completed\" type=\"hidden\" value=\"parent._zw.fu.complete\" />");
            sb.Append("<label class=\"custom-file-label\" for=\"customFile\">이미지 / 문서 첨부</label>");
            sb.Append("</div>"); //custom-file
            sb.Append("</form>");
            sb.Append("<div class=\"ml-2\">");
            sb.Append("<button class=\"btn btn-outline-info btn-18 rounded-circle\" data-toggle=\"popover\" data-placement=\"bottom\" data-original-title=\"첨부 가능한 파일 형식은 다음과 같습니다\"><i class=\"fas fa-question fs-11\"></i></button>");
            sb.Append("<div class=\"d-none\" data-help=\"file\">");
            sb.Append("<div>");
            sb.Append("<div class=\"row\">");
            sb.Append("<div class=\"col-3 font-weight-bold\">* 이미지</div>");
            sb.Append("<div class=\"col-9\" data-for=\"ext\">JPEG, JPG, GIF, PNG</div>");
            sb.Append("</div>"); //row
            sb.Append("<div class=\"row\">");
            sb.Append("<div class=\"col-3 font-weight-bold\">* 문서</div>");
            sb.Append("<div class=\"col-9\" data-for=\"ext\">PPT, PPTX, XLS, XLSX, DOC, DOCX, PDF, HWP, TXT</div>");
            sb.Append("</div>"); //row
                                 //sb.Append("<div class=\"row\">");
                                 //sb.Append("<div class=\"col-3 font-weight-bold\">* 동영상</div>");
                                 //sb.Append("<div class=\"col-9\" data-for=\"ext\">MOV, MP4, AVI</div>");
                                 //sb.Append("</div>"); //row
            sb.Append("</div>");
            sb.Append("</div>"); //data-help
            sb.Append("</div>"); //ml-2
            sb.Append("</div>"); //d-flex
        }

        sb.AppendFormat("<div class=\"zf-upload-list border rounded mt-1 px-2 pt-2 pb-0{0}\">", file == null || file.Count == 0 ? " d-none" : "");

        if (file != null && file.Count > 0)
        {
            foreach (JObject j in file)
            {
                sb.Append("<div class=\"d-flex align-items-center mb-1\">");
                sb.AppendFormat("<div class=\"mr-1\"><i class=\"{0}\"></i></div>", ZumNet.Web.Bc.CommonUtils.GetFileExt(j["ext"].ToString()));
                sb.AppendFormat("<div class=\"mr-1\"><a href=\"/Common/DownloadV?fn={0}&fp={1}\" target=\"_blank\">{2}</a></div>"
                                , Server.UrlEncode(SecurityHelper.ToBase64(j["filename"].ToString()))
                                , Server.UrlEncode(SecurityHelper.ToBase64(j["filepath"].ToString() + "\\" + j["savedname"].ToString()))
                                , j["filename"]);
                sb.AppendFormat("<div class=\"mr-1 text-muted\">{0}</div>", ZumNet.Web.Bc.CommonUtils.StrFileSize(j["size"].ToString()));

                if (mode == "edit")
                {
                    sb.AppendFormat("<div class=\"text-muted\"><button class=\"btn btn-default btn-sm btn-18\" onclick=\"_zw.fu.delete('{0}', '{1}', '{2}');\"><i class=\"fe-x\"></i></button></div>"
                                , j["attachid"].ToString()
                                , Server.UrlEncode(j["filename"].ToString())
                                , Server.UrlEncode(SecurityHelper.ToBase64(j["filepath"].ToString() + "\\" + j["savedname"].ToString())));
                }

                sb.Append("</div>");
            }
        }
        sb.AppendFormat("<textarea id=\"__FILEINFO\" style=\"display:none\">{0}</textarea>", JsonConvert.SerializeObject(file));
        sb.Append("</div>");
        sb.Append("</div>"); //zf-upload

        return sb.ToString();
    }
}
<div class="modal-dialog modal-dialog-scrollable" style="max-width: 40rem">
    <div class="modal-content bg-white" style="box-shadow: 0px 5px 15px rgba(0,0,0,0.5)">
        <div class="modal-header">
            <h5 class="modal-title">자원예약 수정</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">×</span>
            </button>
        </div>
    @if (!bEditable)
    {
        <div class="modal-body">
            <div class="text-center my-5">@Resources.Global.Auth_NoPermission</div>
        </div>
        <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-default px-3" data-dismiss="modal">@Resources.Global.Close</button>
        </div>
    }
    else
    {
        <div class="modal-body">
            <div class="form-group row mb-1 mb-sm-3">
                <label for="txtSubject" class="col-sm-2 col-form-label font-weight-normal">제목</label>
                <div class="col-sm-10 input-group align-items-center">
                    <label class="custom-control custom-checkbox m-0 mr-2">
                        <input type="checkbox" class="custom-control-input" name="ckbPrioriy" id="ckb01"@(jApp["priority"].ToString() == "H" ? " checked" : "") />
                        <span class="custom-control-label">중요</span>
                    </label>
                    <input type="text" class="form-control" id="txtSubject" value="@jApp["subject"]">
                </div>
            </div>
            <div class="form-group row mb-2 mb-sm-3">
                <label for="txtLocation" class="col-sm-2 col-form-label font-weight-normal">장소 / 범주</label>
                <div class="col-sm-10 input-group align-items-center">
                    <input type="text" class="form-control" id="txtLocation" value="@jApp["location"]">
                    <select class="custom-select" id="ddlSchType" style="max-width: 120px">
                    @foreach (DataRow dr in ViewBag.SchType)
                    {
                        <option style="color: @dr["Color"]" value="@dr["SchType"]" @(jApp["schtype"].ToString() == dr["SchType"].ToString() ? " selected" : "")>&#9632; @dr["TypeName"]</option>
                    }
                    </select>
                </div>
            </div>
            <div class="form-group row mb-1 mb-sm-3">
                <label for="" class="col-sm-2 col-form-label font-weight-normal">일시</label>
                <div class="col-sm-10 input-daterange">
                    <div class="form-group row mb-1">
                        <div class="col-sm-2 d-none d-sm-block col-form-label">시작</div>
                        <div class="col-sm-10  input-group align-items-center">
                            <input type="text" class="form-control mr-2" id="txtStart" value="@Convert.ToDateTime(jApp["periodfrom"]).ToShortDateString()" style="max-width: 110px">
                            <select class="custom-select" id="cbStart">
                                @Html.Raw(CommonUtils.OptionTime(dtStart.Hour, dtStart.Minute))
                            </select>
                            <label class="custom-control custom-checkbox m-0 ml-2">
                                <input type="checkbox" class="custom-control-input" name="ckbAllDay" id="ckb02" @(jApp["end"].ToString() == "24:00" ? "checked" : "")>
                                <span class="custom-control-label">종일</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group row mb-0">
                        <div class="col-sm-2 d-none d-sm-block col-form-label">종료</div>
                        <div class="col-sm-10 input-group align-items-center">
                            <input type="text" class="form-control mr-2" id="txtEnd" value="@Convert.ToDateTime(jApp["periodto"]).ToShortDateString()" style="max-width: 110px">
                            <select class="custom-select" id="cbEnd">
                                @Html.Raw(CommonUtils.OptionTime(dtEnd.Hour, dtEnd.Minute))
                            </select>
                            <label class="custom-control custom-checkbox m-0 ml-2">
                                <input type="checkbox" class="custom-control-input" name="ckbRepeat" id="ckb03" @(jApp["repeat"]["type"].ToString() != "0" ? "checked" : "")>
                                <span class="custom-control-label">반복</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            @if (jApp["repeat"]["type"].ToString() != "0")
            {
                <div class="form-group row mb-1 mb-sm-3">
                    <label for="" class="col-sm-2 col-form-label font-weight-normal"></label>
                    <div class="col-sm-10 input-group align-items-center">
                        @Html.Raw(GetRepeatDesc(jApp))
                    </div>
                </div>
            }

            <div class="form-group row mb-1 mb-sm-3">
                <div class="col-sm-2 col-form-label dropdown">
                    <label for="txtSubject" class="font-weight-normal mb-0">신청 자원</label>
                </div>
                <div class="col-sm-10">
                    @foreach (JObject j in (JArray)jApp["partlist"])
                    {
                        <div class="col-form-label" data-val="@j["ot"].@j["partid"]">@j["partdn"]@Html.Raw(GetStateIcon(j["approval"].ToString(), j["confirmed"].ToString(), j["state"].ToString()))</div>
                    }
                </div>
            </div>
            <div class="form-group row">
                <label for="rdoState" class="col-sm-2 col-form-label font-weight-normal">파일</label>
                <div class="col-sm-10 input-group align-items-center">
                    @*@foreach (JObject j in (JArray)jApp["attachlist"])
                    {
                        @Html.Raw(LInkAttachFile(j))
                    }*@
                    @Html.Raw(RenderFile("edit", (JArray)jApp["attachlist"]))
                </div>
            </div>
            <div class="form-group mb-1 mb-sm-3">
                <textarea class="form-control bootstrap-maxlength" id="txtBody" rows="5" maxlength="1000">@Html.Raw(ZumNet.Framework.Web.HtmlHandler.BodyInnerHtml(jApp["body"].ToString()))</textarea>
            </div>
            <div class="form-group row mb-0">
                <label for="" class="col-sm-2 col-form-label font-weight-normal">작성</label>
                <div class="col-sm-10 input-group align-items-center">
                    <span class="mr-3">@jApp["creur"]</span><span>@CommonUtils.CheckDateTime(jApp["credate"].ToString())</span>
                </div>
            </div>
        </div>

        <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-outline-secondary px-3 font-weight-bold" data-zm-menu="save">@Resources.Global.Save</button>
            <button type="button" class="btn btn-default px-3" data-dismiss="modal">@Resources.Global.Cancel</button>
        </div>
    }
    </div>
</div>
