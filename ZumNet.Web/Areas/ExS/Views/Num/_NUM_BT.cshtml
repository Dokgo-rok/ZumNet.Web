@using System.Collections;
@using System.Data;
@using System.Text;
@using System.Threading;
@using Newtonsoft.Json.Linq;
@using ZumNet.Framework.Util;
@{
    ZumNet.Framework.Core.ServiceResult svcRt = null;

    InitConfig();

    string command = ViewBag.R["ft"].ToString().Split('_')[1];
    if (ViewBag.R.mode == "xls")
    {
        ViewBag.R.lv["page"] = "1";
        ViewBag.R.lv["count"] = "100000";
    }

    using (ZumNet.BSL.InterfaceBiz.ReportBiz rpBiz = new ZumNet.BSL.InterfaceBiz.ReportBiz())
    {
        svcRt = rpBiz.GetRegisterNumberList(command, ViewBag.R["ft"].ToString(), ViewBag.R.lv["cd1"].ToString(), ViewBag.R.lv["cd2"].ToString()
                        , StringHelper.SafeInt(ViewBag.R.lv["page"].ToString()), StringHelper.SafeInt(ViewBag.R.lv["count"].ToString()), ViewBag.R.lv["basesort"].ToString()
                        , ViewBag.R.lv["sort"].ToString(), ViewBag.R.lv["sortdir"].ToString(), ViewBag.R.lv["search"].ToString(), ViewBag.R.lv["searchtext"].ToString());
    }

    if (svcRt != null && svcRt.ResultCode == 0)
    {
        ViewBag.R.lv["total"] = svcRt.ResultItemCount.ToString();
    }
    else
    {
        ViewBag.R.lv["total"] = 0;
    }

    if (ViewBag.R.mode == "xls")
    {
        ExcelBind(ViewList(ViewBag.R.mode.ToString(), svcRt.ResultDataSet));
        Response.End();
    }
}
@functions {
    string[,] _columnConfig = null;
    string _tblWidth = "";

    private void InitConfig()
    {
        //초기 설정
        string[,] arr = {  { "PARTNO", "품번", "15%", "", "Y", "Y" }, { "MODEL", "모델명", "15%", "L", "Y", "Y" }, { "ITEM", "부품명", "15%", "L", "Y", "Y" }
                            , { "REASON", "기타사항", "25%", "L", "", "" }, { "REGISTRANTDEPT", "등록부서", "10%", "", "", "" }
                            , { "REGISTRANTUSER", "등록자", "10%", "", "", "" }, { "INDATE", "등록일", "10%", "", "Y", "Y" }
            };
        this._columnConfig = arr;
        this._tblWidth = "100%";
        ViewBag.R.lv["basesort"] = "PARTNO";

        if (ViewBag.R.lv["page"] == null || ViewBag.R.lv["page"].ToString() == "") ViewBag.R.lv["page"] = "1";
        if (ViewBag.R.lv["count"] == null || ViewBag.R.lv["count"].ToString() == "") ViewBag.R.lv["count"] = "20";
    }

    private string RenderColumnHeader(string mode)
    {
        StringBuilder sb = new StringBuilder();
        string sClassExcel = mode == "xls" ? " class=\"xls_th\"" : "";

        if (_columnConfig != null && _columnConfig.GetLength(0) > 0)
        {
            sb.AppendFormat("<colgroup span=\"{0}\">", _columnConfig.GetLength(0));
            for (int i = 0; i < _columnConfig.GetLength(0); i++)
            {
                sb.AppendFormat("<col style=\"width:{0}\" />", _columnConfig[i, 2].ToString());
            }
            sb.Append("</colgroup>");

            sb.Append("<thead>");
            sb.Append("<tr class=\"table-success\">");
            for (int i = 0; i < _columnConfig.GetLength(0); i++)
            {
                if (mode != "xls" && _columnConfig[i, 4].ToString() == "Y")
                {
                    sb.AppendFormat("<th><a class=\"z-lnk-navy\" href=\"javascript:\" data-val=\"{0}\" onclick=\"_zw.fn.sort();\">{1} <i class=\"{2}\"</a></th>"
                                        , _columnConfig[i, 0].ToString(), _columnConfig[i, 1].ToString()
                                    , (ViewBag.R.lv.sort == _columnConfig[i, 0].ToString() ? (ViewBag.R.lv.sortdir == "ASC" ? "fe-arrow-up" : "fe-arrow-down") : ""));
                }
                else sb.AppendFormat("<th{0}>{1}</th>", sClassExcel, _columnConfig[i, 1].ToString());
            }
            sb.Append("</tr>");
            sb.Append("</thead>");
        }

        return sb.ToString();
    }

    private string ViewList(string mode, DataSet data)
    {
        if (data != null && data.Tables.Count > 0)
        {
            string strHeader = RenderColumnHeader(mode);
            string strID = "";
            string strValue = "";
            int iRow = 1;

            StringBuilder sb = new StringBuilder();
            sb.AppendFormat("<table class=\"table table-hover table-bordered table-sm\" style=\"width:{0}\">", this._tblWidth);
            sb.Append(strHeader);
            sb.Append("<tbody>");

            if (strHeader == "")
            {
                sb.AppendFormat("<tr><th>{0}</th></tr>", "뷰 정보가 없습니다.");
            }
            else
            {
                foreach (DataRow row in data.Tables[0].Rows)
                {
                    sb.Append("<tr>");
                    for (int i = 0; i < _columnConfig.GetLength(0); i++)
                    {
                        strID = _columnConfig[i, 0].ToString();

                        if (strID == "INDATE")
                        {
                            strValue = ZumNet.Web.Bc.CommonUtils.CheckDateTime(row[strID].ToString(), "yy-MM-dd", "");
                        }
                        else
                        {
                            strValue = row[strID].ToString();
                        }
                        strValue = (strValue.Trim() == "") ? "&nbsp;" : strValue;

                        sb.AppendFormat("<td class=\"{0}\">{1}</td>", _columnConfig[i, 3].ToString() == "L" ? "text-left" : "text-center", strValue);
                    }
                    sb.Append("</tr>");
                    iRow++;
                }
            }
            sb.Append("</tbody>");
            sb.Append("</table>");

            return sb.ToString();
        }
        return "";
    }

    private string ListCount()
    {
        string sPage = "";
        int totalCount = 0;
        int maxPage = ZumNet.Web.Bc.CommonUtils.IsMobile() ? 5 : 10;
        totalCount = Convert.ToInt32(ViewBag.R.lv.total.Value);
        int pageCount = Convert.ToInt32(ViewBag.R.lv.count.Value);
        int pageIndex = Convert.ToInt32(ViewBag.R.lv.page.Value);
        int totalPage = totalCount / pageCount;

        if (totalCount % pageCount > 0) { totalPage++; }
        if (pageIndex > totalPage) { pageIndex = totalPage; }

        sPage = String.Format("{0} {1} {2} ({3} / {4} {5})", Resources.Global.Total, totalCount.ToString(), Resources.Global.Count, pageIndex.ToString(), totalPage.ToString(), Resources.Global.Page);


        return sPage;
    }

    private string ListCond()
    {
        string sWidth = _columnConfig != null && _columnConfig.GetLength(0) > 0 ? " wd-md-80 wd-lg-65 wd-xl-60" : " wd-sm-80 wd-md-60 wd-lg-45 wd-xl-40";

        StringBuilder sb = new StringBuilder();

        sb.AppendFormat("<div class=\"z-list-cond d-flex justify-content-end wd-70{0}\">", sWidth);

        sb.Append("<div class=\"z-list-search input-group d-flex\">");

        sb.Append("<select class=\"custom-select\" data-for=\"cd1\">");
        sb.Append("<option value=\"H\">H</option>");
        sb.Append("</select>");

        sb.Append("<select class=\"custom-select\" data-for=\"cd2\">");
        sb.Append("<option value=\"B\">B</option>");
        sb.Append("</select>");

        sb.Append("<select class=\"custom-select\" id=\"_SearchSelect\">");
        sb.AppendFormat("<option value=\"\">{0}</option>", Resources.Global.Select);
        for (int i = 0; i < _columnConfig.GetLength(0); i++)
        {
            if (_columnConfig[i, 4].ToString() == "Y")
            {
                sb.AppendFormat("<option value=\"{0}\"{2}>{1}</option>", _columnConfig[i, 0].ToString(), _columnConfig[i, 1].ToString(), _columnConfig[i, 0].ToString() == ViewBag.R.lv.search.ToString() ? " selected" : "");
            }
        }
        sb.Append("</select>");
        sb.AppendFormat("<input type=\"text\" class=\"form-control\" id=\"_SearchText\" placeholder=\"{0}\" value=\"{1}\">", Resources.Global.Search, ViewBag.R.lv.searchtext.ToString());

        sb.Append("<span class=\"input-group-append\">");
        sb.Append("<button class=\"btn btn-secondary\" type=\"button\" data-zv-menu=\"search\"><i class=\"fe-search\"></i></button>");
        sb.Append("</span>");
        sb.Append("</div>");

        sb.Append("</div>"); //z-list-cond
        return sb.ToString();
    }

    private void ExcelBind(string data)
    {
        string strExcelFileName = ViewBag.R.ft.ToString() + "_Export_" + DateTime.Now.ToString("yyMMdd_HHmmss") + ".xls"; //2014-04-11
        Response.Clear();
        Response.Charset = "utf-8";
        Response.Buffer = true;
        //EnableViewState = false;
        Response.AddHeader("content-disposition", "attachment;filename=" + strExcelFileName); //Content.xls");
        Response.ContentType = "application/x-msdownload";
        string encoding = Request.ContentEncoding.HeaderName;
        Response.Write("<html xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\" xmlns=\"http://www.w3.org/TR/REC-html40\"><head>");
        Response.Write("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=" + encoding + "\">");
        Response.Write("<style type=\"text/css\">" + ExcelStyle() + "</style>");
        Response.Write("</head>");
        Response.Write("<body>");
        Response.Write(data);
        Response.Write("</body></html>");
    }

    public string ExcelStyle()
    {
        return @"
body {width: 100%}
table {width: ; border-top: 0.1pt solid windowtext; border-right: 0.1pt solid windowtext}
td {border-bottom: 0.1pt solid windowtext; border-left: 0.1pt solid windowtext; padding: 4px;}

.xls_warning {background-color: #fcf8e3}
.xls_th {border-bottom: 0.1pt solid windowtext; border-left: 0.1pt solid windowtext; padding: 4px; text-align: center; background-color: #dff0d8}

.text-center {text-align: center}
.xl66 {mso-number-format:'\#\,\#\#0\.0000\;\[Red\]\\-\#\,\#\#0\.0000';}
.xl88 {mso-number-format:'\#\,\#\#0\.0000_\)\;\[Red\]\\\(\#\,\#\#0\.0000\\\)';}
";
    }
}
@if (svcRt == null || svcRt.ResultCode != 0)
{
    @Html.Partial("~/Views/Shared/_ErrorInline.cshtml", new HandleErrorInfo(new Exception(svcRt.ResultMessage), "Report", ViewBag.R.ttl.ToString()))
}
else
{
    <div class="z-list-head d-flex justify-content-between my-2 pl-0">
        <div class="z-list-page d-flex align-items-center justify-content-between" id="__ListCount">
            <div class="z-list-total d-flex align-items-center mr-1">
                <i class="fe-chevron-right"></i> @ListCount()
            </div>
            <div class="input-group d-none d-sm-flex z-lv-cnt">
                <select class="custom-select">
                    <option value="10" @(Convert.ToInt32(ViewBag.R.lv.count.Value) == 10 ? " selected" : "")>10</option>
                    <option value="20" @(Convert.ToInt32(ViewBag.R.lv.count.Value) == 20 ? " selected" : "")>20</option>
                    <option value="30" @(Convert.ToInt32(ViewBag.R.lv.count.Value) == 30 ? " selected" : "")>30</option>
                    <option value="40" @(Convert.ToInt32(ViewBag.R.lv.count.Value) == 40 ? " selected" : "")>40</option>
                    <option value="50" @(Convert.ToInt32(ViewBag.R.lv.count.Value) == 50 ? " selected" : "")>50</option>
                </select>
            </div>
        </div>
        @Html.Raw(ListCond())
    </div>

    <div class="z-list-body" id="__ListView">
        @Html.Raw(ViewList(ViewBag.R.mode.ToString(), svcRt.ResultDataSet))
    </div>

    <script type="text/template" class="zf-num-template">
        <table class="table table-sm mb-0 num-table">
            <colgroup>
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
                <col style="width:6.25%" />
            </colgroup>
            <tbody>
                <tr>
                    <td colspan="16"><h5>Bolt품번채번</h5></td>
                </tr>
                <tr>
                    <td colspan="4"></td>
                    <td colspan="2" class="table-success"><h6>나사산외경</h6></td>
                    <td colspan="2" class="table-warning"><h6>기장</h6></td>
                    <td colspan="2" class="table-info"><h6>머리외경</h6></td>
                    <td colspan="2" class="table-danger"><h6>머리두께</h6></td>
                    <td colspan="4"></td>
                </tr>
                <tr data-for="num">
                    <td><input type="text" class="form-control" maxlength="1" readonly value="C" /></td>
                    <td><input type="text" class="form-control" maxlength="1" readonly value="H" /></td>
                    <td><input type="text" class="form-control" maxlength="1" readonly value="B" /></td>
                    <td><input type="text" class="form-control" maxlength="1" readonly value="-" /></td>
                    <td class="table-success"><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                    <td class="table-success"><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                    <td class="table-warning"><input type="text" class="form-control" maxlength="1" value="" /></td>
                    <td class="table-warning"><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                    <td class="table-info"><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                    <td class="table-info"><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                    <td class="table-danger"><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                    <td class="table-danger"><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                    <td><input type="text" class="form-control" maxlength="1" readonly value="" data-for="color;514" /></td>
                    <td><input type="text" class="form-control" maxlength="1" readonly value="" data-for="bt_type;98" /></td>
                    <td><input type="text" class="form-control" maxlength="1" readonly value="" data-for="bt_thread;154" /></td>
                    <td><input type="text" class="form-control" maxlength="1" readonly value="" data-for="bt_head;154" /></td>
                </tr>
                <tr>
                    <td colspan="3" class="text-center">모델명</td>
                    <td colspan="13"><input type="text" class="form-control text-left" maxlength="100" data-column="MODEL" /></td>
                </tr>
                <tr>
                    <td colspan="3" class="text-center">부품명</td>
                    <td colspan="13"><input type="text" class="form-control text-left" maxlength="100" data-column="ITEM" /></td>
                </tr>
                <tr>
                    <td colspan="3" class="text-center">기타사항</td>
                    <td colspan="13"><input type="text" class="form-control text-left" maxlength="100" data-column="ETC" /></td>
                </tr>
            </tbody>
        </table>
    </script>
    <script type="text/template" class="zf-numcode-template" data-for="bt_type">
        <table class="table table-striped table-sm mb-0 text-center">
            <colgroup><col style="width:20%" /><col /></colgroup>
            <thead><tr><th>코드</th><th>설명</th></tr></thead>
            <tbody>
                @foreach (object[] o in ViewBag.CodeTable["partnum.bt_type"])
                {
                    <tr>
                        <td>@o[3].ToString()</td>
                        <td><a class="z-lnk-navy" href="javascript:void(0)" data-val="@o[3].ToString()">@o[4].ToString()</a></td>
                    </tr>
                }
            </tbody>
        </table>
    </script>
    <script type="text/template" class="zf-numcode-template" data-for="bt_thread">
        <table class="table table-striped table-sm mb-0 text-center">
            <colgroup><col style="width:20%" /><col /></colgroup>
            <thead><tr><th>코드</th><th>설명</th></tr></thead>
            <tbody>
                @foreach (object[] o in ViewBag.CodeTable["partnum.bt_thread"])
                {
                    <tr>
                        <td>@o[3].ToString()</td>
                        <td><a class="z-lnk-navy" href="javascript:void(0)" data-val="@o[3].ToString()">@o[4].ToString()</a></td>
                    </tr>
                }
            </tbody>
        </table>
    </script>
    <script type="text/template" class="zf-numcode-template" data-for="bt_head">
        <table class="table table-striped table-sm mb-0 text-center">
            <colgroup><col style="width:20%" /><col /></colgroup>
            <thead><tr><th>코드</th><th>설명</th></tr></thead>
            <tbody>
                @foreach (object[] o in ViewBag.CodeTable["partnum.bt_head"])
                {
                    <tr>
                        <td>@o[3].ToString()</td>
                        <td><a class="z-lnk-navy" href="javascript:void(0)" data-val="@o[3].ToString()">@o[4].ToString()</a></td>
                    </tr>
                }
            </tbody>
        </table>
    </script>
    <script type="text/template" class="zf-numcode-template" data-for="color">
        <table class="table table-striped table-sm mb-0 text-center">
            <colgroup><col style="width:20%" /><col /></colgroup>
            <thead><tr><th>코드</th><th>설명</th></tr></thead>
            <tbody>
                @foreach (object[] o in ViewBag.CodeTable["partnum.color"])
                {
                    <tr>
                        <td>@o[3].ToString()</td>
                        <td><a class="z-lnk-navy" href="javascript:void(0)" data-val="@o[3].ToString()">@o[4].ToString()</a></td>
                    </tr>
                }
            </tbody>
        </table>
    </script>
}

