@using System.Data;
@using System.Text;
@using System.Threading;
@using Newtonsoft.Json;
@{
    ViewBag.Title = "품번채번작성기준표";
    Layout = "~/Views/Shared/Layouts/_LayoutBlank.cshtml";
}
@section Styles {
    @Styles.Render("~/Content/num.css")
}
@section Scripts {
    @Scripts.Render("~/bundle/vendor/js/bootstrap-maxlength/bootstrap-maxlength")
    @Scripts.Render("~/bundle/vendor/js/vanilla-text-mask/vanilla-text-mask")
    @Scripts.Render("~/bundle/vendor/js/vanilla-text-mask/text-mask-addons")
    @*@Scripts.Render("~/Scripts/ExS/num.js")*@

    <script type="text/javascript">(function () {_zw.V = @Html.Raw(JsonConvert.SerializeObject(ViewBag.R))}());</script>
    <script type="text/javascript">
        $(function () {
            $('.num-sheet td[data-cutcnt]').on('mouseover', function () { $(this).addClass('over'); });
            $('.num-sheet td[data-cutcnt]').on('mouseout', function () { $(this).removeClass('over'); });
            $('body').on('contextmenu', function () { return false; });

            var eSelectedCell = null;
            $('.num-sheet td[data-num]').on('mousedown', function (e) {
                var el = e.target; //console.log(el)
                if (eSelectedCell) {
                    $(eSelectedCell).removeClass('over');
                    $(eSelectedCell).removeClass('clc');
                }
                $(el).removeClass('over').addClass('clc'); eSelectedCell = el;

                if (e.which == 1) {
                    if ($(el).attr('data-cutcnt') != undefined && $.trim($(el).text()) != '') {
                        var pno = 'C' + $(el).attr('data-num').substr(0, 1) + $(el).attr('data-num').substr(1, 1) + '-';
                        $.post("/ExS/Num/LastNum", '{"ft":"' + _zw.V.ft + '","part":"' + pno + '"}', function (res) {
                            if (res.substr(0, 2) == 'OK') {
                                var vRes = res.substr(2);
                                var j = { "close": true, "width": 600, "height": 220, "left": -40, "top": 0 }
                                j["content"] = $('.zf-num-template').html();
                                j["footer"] = '<button type="button" class="btn btn-primary mr-1" data-zm-menu="confirm">저장</button><button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>';

                                var pop = _zw.ut.popup(el, j);
                                pop.find('.z-pop-body table tr[data-for="num"] td input').each(function (idx) {
                                    if (idx == 0) $(this).val(pno.substr(0, 1));
                                    else if (idx == 1) $(this).val(pno.substr(1, 1));
                                    else if (idx == 2) $(this).val(pno.substr(2, 1));
                                    else if (idx == 4) $(this).val(vRes.substr(0, 1));
                                    else if (idx == 5) $(this).val(vRes.substr(1, 1));
                                    else if (idx == 6) $(this).val(vRes.substr(2, 1));
                                    else if (idx == 7) $(this).val(vRes.substr(3, 1));
                                });

                                pop.find('.z-pop-footer .btn[data-dismiss="modal"]').click(function () { $(eSelectedCell).removeClass('clc'); $('.modal-backdrop').remove(); pop.remove(); });
                                pop.find('.close[data-dismiss="modal"]').click(function () { $(eSelectedCell).removeClass('clc'); });

                                pop.find('.z-pop-body table tr[data-for="num"] input[data-for]').css('cursor', 'pointer').click(function () {
                                    var tgt = $(this), attr = tgt.attr('data-for').split(';');
                                    var jc = { "close": true, "width": 300, "height": parseInt(attr[1]), "left": 0, "top": 0 };
                                    jc["content"] = $('.zf-numcode-template[data-for="' + attr[0] + '"]').html();

                                    var pc = _zw.ut.popup(tgt[0], jc);
                                    pc.find('a[data-val]').click(function () {
                                        var v = $(this).attr('data-val'); tgt.val(v);
                                        if (attr[0] == 'color') {
                                            var sPartNo = '', pos = null;
                                            tgt.parent().parent().find('input').each(function (idx) {
                                                sPartNo += $.trim($(this).val());
                                                if (idx == 13) pos = $(this);
                                            });

                                            if (sPartNo.length >= 13) {
                                                $.post("/ExS/Num/LastNum", '{"ft":"' + _zw.V.ft + '","part":"' + sPartNo + '"}', function (res) {
                                                    if (res.substr(0, 2) == 'OK') pos.val(res.substr(2));
                                                    else bootbox.alert(res);
                                                    pc.find('.close[data-dismiss="modal"]').click();
                                                });
                                            } else bootbox.alert('잘못된 채번입니다. 재확인이 필요합니다!', function () {
                                                tgt.val(''); pos.val('');
                                                pc.find('.close[data-dismiss="modal"]').click();
                                            });
                                        } else pc.find('.close[data-dismiss="modal"]').click();
                                    });
                                });

                                pop.find('.z-pop-footer .btn[data-zm-menu="confirm"]').click(function () {
                                    var sPartNo = '';
                                    pop.find('.z-pop-body table tr[data-for="num"] td input').each(function () {
                                        sPartNo += $.trim($(this).val());
                                    });
                                    if (sPartNo.length != 14) {
                                        bootbox.alert("채번오류 : 미입력 번호가 있습니다"); return false;
                                    } else {
                                        var postData = {};
                                        postData['ft'] = _zw.V.ft;
                                        postData['part'] = sPartNo;
                                        postData['ur'] = _zw.V.current.user;
                                        postData['urid'] = _zw.V.current.urid;
                                        postData['dept'] = _zw.V.current.dept;
                                        postData['deptid'] = _zw.V.current.deptid;
                                        postData['model'] = pop.find('.z-pop-body table tr td input[data-column="MODEL"]').val();
                                        postData['item'] = pop.find('.z-pop-body table tr td input[data-column="ITEM"]').val();
                                        postData['etc'] = pop.find('.z-pop-body table tr td input[data-column="ETC"]').val();

                                        $.post("/ExS/Num/SetNum", JSON.stringify(postData), function (res) {
                                            if (res.substr(0, 2) == 'OK') {
                                                bootbox.alert(res.substr(2));
                                                pop.find('.close[data-dismiss="modal"]').click();
                                            } else bootbox.alert(res);
                                        });
                                    }
                                });

                                _zw.fn.input(pop);

                            } else bootbox.alert(res);
                        });
                    }
                } else if (e.which == 3) {
                    var j = { "close": true, "width": 300, "height": 124, "left": -40, "top": 0 }
                    j["content"] = $('.zf-numsheet-template').html();
                    j["footer"] = '<button type="button" class="btn btn-primary mr-1" data-zm-menu="confirm">저장</button><button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>';

                    $(el).attr('data-num').substr(0, 1) + $(el).attr('data-num').substr(1, 1)

                    var pop = _zw.ut.popup(el, j);
                    pop.find('.z-pop-body table h5').text($(el).attr('data-num'));
                    pop.find('.z-pop-body table input[data-column="COLVAL"]').val($(el).text());

                    pop.find('.z-pop-footer .btn[data-dismiss="modal"]').click(function () { $(eSelectedCell).removeClass('clc'); $('.modal-backdrop').remove(); pop.remove(); });
                    pop.find('.close[data-dismiss="modal"]').click(function () { $(eSelectedCell).removeClass('clc'); });

                    pop.find('.z-pop-footer .btn[data-zm-menu="confirm"]').click(function () {
                        var colVal = pop.find('.z-pop-body input[data-column="COLVAL"]');

                        if ($.trim(colVal.val()) != '') {
                            var postData = {};
                            postData['ft'] = _zw.V.ft;
                            postData['nm'] = pop.find('.z-pop-body table h5').text();
                            postData['val'] = colVal.val();
                            $.post("/ExS/Num/SetNumSheet", JSON.stringify(postData), function (res) {
                                if (res == 'OK') window.location.reload();
                                else bootbox.alert(res);
                            });
                        } else colVal.focus();
                    });
                }
            });
        });
    </script>
}
@functions {
    private string[] _columns = { "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z" };

    private string RenderNumberSheet(DataTable data)
    {
        if (data != null)
        {
            string oddclass = "";
            string strTdClass = ""; //2018-09-19 추가
            string strEvent = ""; //2018-09-19 추가
            int iRow = 1;

            StringBuilder sb = new StringBuilder();
            sb.Append("<table class=\"num-sheet text-center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">");
            sb.Append("<colgroup>");

            for (int i = 1; i <= _columns.Length + 2; i++)
            {
                sb.AppendFormat("<col style=\"width:{0}%\" />", "3.571");
            }
            sb.Append("</colgroup>");

            sb.Append("<thead><tr>");
            sb.Append("<th>중분류</th><th></th>");
            for (int i = 0; i < _columns.Length; i++)
            {
                sb.AppendFormat("<th>{0}</th>", _columns[i].ToString());
            }
            sb.Append("</tr></thead");

            sb.Append("<tbody>");
            if (data != null && data.Rows.Count > 0)
            {
                foreach (DataRow row in data.Rows)
                {
                    oddclass = (iRow % 2 == 0) ? "even" : "odd";
                    strTdClass = " class=\"filled\"";

                    if (row["CUTCNT"].ToString() == "1")
                    {
                        sb.AppendFormat("<tr class=\"{2}\"><td data-num=\"{0}0\">{1}</td><th>{0}</th>", row["COLNM"].ToString()[0], row["COLVAL"].ToString(), oddclass);
                    }
                    else if (row["CUTCNT"].ToString() == "27")
                    {
                        sb.AppendFormat("<td data-cutcnt=\"{2}\" data-num=\"{0}\"{3}>{1}</td></tr>", row["COLNM"].ToString(), row["COLVAL"], row["CUTCNT"].ToString(), strTdClass);
                    }
                    else
                    {
                        sb.AppendFormat("<td data-cutcnt=\"{2}\" data-num=\"{0}\"{3}>{1}</td>", row["COLNM"].ToString(), row["COLVAL"], row["CUTCNT"].ToString(), strTdClass);
                    }
                    iRow++;
                }
            }
            else
            {
                sb.AppendFormat("<tr><td colspan=\"28\">{0}</td></tr>", Resources.Global.NoItemShow);
            }
            sb.Append("</tbody>");
            sb.Append("</table>");

            return sb.ToString();
        }
        return "";
    }
}
<div class="layout-wrapper">
    <div class="layout-inner">
        @Html.Raw(RenderNumberSheet(ViewBag.BoardList))
    </div>
</div>

<script type="text/template" class="zf-numsheet-template">
    <table class="table table-striped table-sm mb-0 text-center">
        <tbody>
            <tr>
                <td><h5 class="mb-0"></h5></td>
            </tr>
            <tr>
                <td><input type="text" class="form-control text-center" maxlength="33" data-column="COLVAL" /></td>
            </tr>
        </tbody>
    </table>
</script>
<script type="text/template" class="zf-num-template">
    <table class="table table-sm mb-0 num-table">
        <colgroup>
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
            <col style="width:7.14%" />
        </colgroup>
        <tbody>
            <tr>
                <td colspan="14"><h5>기구품번채번</h5></td>
            </tr>
            <tr data-for="num">
                <td><input type="text" class="form-control" maxlength="1" readonly value="" /></td>
                <td><input type="text" class="form-control" maxlength="1" readonly value="" /></td>
                <td><input type="text" class="form-control" maxlength="1" readonly value="" /></td>
                <td><input type="text" class="form-control" maxlength="1" readonly value="-" /></td>
                <td><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                <td><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                <td><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                <td><input type="text" class="form-control" maxlength="1" data-inputmask="number-n;1" value="" /></td>
                <td><input type="text" class="form-control" maxlength="1" readonly value="" data-for="me_dir;514" /></td>
                <td><input type="text" class="form-control" maxlength="1" readonly value="" data-for="me_postproc;514" /></td>
                <td><input type="text" class="form-control" maxlength="1" readonly value="" data-for="me_print;214" /></td>
                <td><input type="text" class="form-control" maxlength="1" readonly value="-" /></td>
                <td><input type="text" class="form-control" maxlength="1" readonly value="" data-for="color;514" /></td>
                <td><input type="text" class="form-control" maxlength="1" readonly value="" /></td>
            </tr>
            <tr>
                <td colspan="3" class="text-center">모델명</td>
                <td colspan="11"><input type="text" class="form-control text-left" maxlength="100" data-column="MODEL" /></td>
            </tr>
            <tr>
                <td colspan="3" class="text-center">부품명</td>
                <td colspan="11"><input type="text" class="form-control text-left" maxlength="100" data-column="ITEM" /></td>
            </tr>
            <tr>
                <td colspan="3" class="text-center">기타사항</td>
                <td colspan="11"><input type="text" class="form-control text-left" maxlength="100" data-column="ETC" /></td>
            </tr>
        </tbody>
    </table>
</script>
<script type="text/template" class="zf-numcode-template" data-for="me_dir">
    <table class="table table-striped table-sm mb-0 text-center">
        <colgroup><col style="width:20%" /><col /></colgroup>
        <thead><tr><th>코드</th><th>설명</th></tr></thead>
        <tbody>
            @foreach (object[] o in ViewBag.CodeTable["partnum.me_dir"])
            {
                <tr>
                    <td>@o[3].ToString()</td>
                    <td><a class="z-lnk-navy" href="javascript:void(0)" data-val="@o[3].ToString()">@o[4].ToString()</a></td>
                </tr>
            }
        </tbody>
    </table>
</script>
<script type="text/template" class="zf-numcode-template" data-for="me_postproc">
    <table class="table table-striped table-sm mb-0 text-center">
        <colgroup><col style="width:20%" /><col /></colgroup>
        <thead><tr><th>코드</th><th>설명</th></tr></thead>
        <tbody>
            @foreach (object[] o in ViewBag.CodeTable["partnum.me_postproc"])
            {
                <tr>
                    <td>@o[3].ToString()</td>
                    <td><a class="z-lnk-navy" href="javascript:void(0)" data-val="@o[3].ToString()">@o[4].ToString()</a></td>
                </tr>
            }
        </tbody>
    </table>
</script>
<script type="text/template" class="zf-numcode-template" data-for="me_print">
    <table class="table table-striped table-sm mb-0 text-center">
        <colgroup><col style="width:20%" /><col /></colgroup>
        <thead><tr><th>코드</th><th>설명</th></tr></thead>
        <tbody>
            @foreach (object[] o in ViewBag.CodeTable["partnum.me_print"])
            {
                <tr>
                    <td>@o[3].ToString()</td>
                    <td><a class="z-lnk-navy" href="javascript:void(0)" data-val="@o[3].ToString()">@o[4].ToString()</a></td>
                </tr>
            }
        </tbody>
    </table>
</script>
<script type="text/template" class="zf-numcode-template" data-for="color">
    <table class="table table-striped table-sm mb-0 text-center">
        <colgroup><col style="width:20%" /><col /></colgroup>
        <thead><tr><th>코드</th><th>설명</th></tr></thead>
        <tbody>
            @foreach (object[] o in ViewBag.CodeTable["partnum.color"])
            {
                <tr>
                    <td>@o[3].ToString()</td>
                    <td><a class="z-lnk-navy" href="javascript:void(0)" data-val="@o[3].ToString()">@o[4].ToString()</a></td>
                </tr>
            }
        </tbody>
    </table>
</script>

