@using System.Collections;
@using System.Data;
@using System.Text;

@using Newtonsoft.Json;

@{
    ConfigColumn(ViewBag.Mode);

    if (ViewBag.Mode == "xls")
    {
        ExcelBind(ViewList(ViewBag.Mode, ViewBag.BoardList, ViewBag.R.lv.sort.ToString(), ViewBag.R.lv.sortdir.ToString()));
        Response.End();
    }
}

@functions {
    string[,] _columnConfig = null;

    private void ConfigColumn(string mode)
    {
        //컬럼 : id,표기,넓이,위치,검색여부,정렬여부
        string[,] arr = { { "rownum", "<input type='checkbox' id='ckbHeader' hidefocus />", "20px", "", "", "" }, { "ApplCorp", "소속", "100px", "", "", "Y" }, { "ApplDept", "부서", "100px", "", "", "Y" }
                        , { "ApplDN", "수강<br />신청자", "70px", "", "", "Y" }, { "ClsDN1", "사내외", "45px", "", "", "" }, { "ClsDN2", "교육<br />방식", "50px", "", "", "" }
                        , { "ClsDN3", "교육<br />유형", "80px", "", "", "Y" }, { "CourseDN", "과정명", "295px", "left", "Y", "Y" }, { "ClsDN4", "교육<br />분야", "100px", "", "Y", "Y" }
                        , { "_INST_", "교육기관<br /> / 강사", "150px", "left", "Y", "" }, { "FromDate", "시작일", "60px", "", "", "Y" }, { "ToDate", "종료일", "60px", "", "", "Y" }
                        , { "CreateDate", "신청일자", "100px", "", "", "Y" }, { "ReqIFState", "신청<br />상태", "70px", "", "", "" }, { "RepoIFState", "보고<br />상태", "70px", "", "", "" }
                        , { "__NOTICEA__", "<input type='checkbox' id='ckbHeader_Req' hidefocus /><label for='ckbHeader_Req'>교육<br />참석알림</label>", "60px", "", "", "" }
                        , { "__NOTICEB__", "과정<br />변경알림", "60px", "", "", "" }
                        , { "__NOTICEC__", "<input type='checkbox' id='ckbHeader_Repo' hidefocus /><label for='ckbHeader_Repo'>결과<br />보고요청</label>", "60px", "", "", "" }};
        this._columnConfig = arr;
    }

    private string RenderColumnHeader(string mode, string sortCol, string sortType)
    {
        if (_columnConfig != null)
        {
            string sBlind = " d-none";
            string sSortIcon = "";

            StringBuilder sb = new StringBuilder();
            sb.AppendFormat("<colgroup span=\"{0}\">", _columnConfig.GetLength(0));
            for (int i = 0; i < _columnConfig.GetLength(0); i++)
            {
                sb.AppendFormat("<col style=\"width:{0}\" />", _columnConfig[i, 2].ToString());
            }
            sb.Append("</colgroup>");

            sb.Append("<thead><tr class=\"table-success\">");
            for (int i = 0; i < _columnConfig.GetLength(0); i++)
            {
                if (_columnConfig[i, 5].ToString() == "Y")
                {
                    sBlind = (sortCol == _columnConfig[i, 0].ToString()) ? "" : " d-none";
                    sSortIcon = (sortCol == _columnConfig[i, 0].ToString() && sortType == "DESC") ? "fe-arrow-down" : "fe-arrow-up";

                    sb.AppendFormat("<th class=\"sortable text-truncate\"><a class=\"z-lnk-navy\" href=\"javascript:\" onclick=\"_zw.fn.sort('{0}');\" title=\"{1}\">{1}<i class=\"{2}{3} font-weight-bold\"></i></a></th>", _columnConfig[i, 0].ToString(), _columnConfig[i, 1].ToString(), sSortIcon, sBlind);
                }
                else
                {
                    sb.AppendFormat("<th class=\"text-truncate\">{0}</th>", _columnConfig[i, 1].ToString());
                }
            }
            sb.Append("</tr></thead>");
            return sb.ToString();
        }
        else
        {
            return "";
        }
    }

    private string RenderExcelColumnHeader()
    {
        if (_columnConfig != null)
        {
            StringBuilder sb = new StringBuilder();
            sb.AppendFormat("<colgroup span=\"{0}\">", _columnConfig.GetLength(0));
            for (int i = 0; i < _columnConfig.GetLength(0); i++)
            {
                sb.AppendFormat("<col style=\"width:{0}\" />", _columnConfig[i, 2].ToString());
            }
            sb.Append("</colgroup>");

            sb.Append("<thead><tr class=\"col-header\">");
            for (int i = 0; i < _columnConfig.GetLength(0); i++)
            {
                if (_columnConfig[i, 0].ToString() == "rownum") sb.AppendFormat("<th style=\"text-align:center;background:#d1dae7;color:#175d7f\">{0}</th>", "");
                else if (_columnConfig[i, 0].ToString() == "__NOTICEA__") sb.AppendFormat("<th style=\"text-align:center;background:#d1dae7;color:#175d7f\">{0}</th>", "참석알림");
                else if (_columnConfig[i, 0].ToString() == "__NOTICEC__") sb.AppendFormat("<th style=\"text-align:center;background:#d1dae7;color:#175d7f\">{0}</th>", "보고요청");
                else  sb.AppendFormat("<th style=\"text-align:center;background:#d1dae7;color:#175d7f\">{0}</th>", _columnConfig[i, 1].ToString());
            }
            sb.Append("</tr></thead>");

            return sb.ToString();
        }
        else
        {
            return "";
        }
    }

    private string ViewList(string mode, DataSet data, string sortCol, string sortType)
    {
        StringBuilder sb = new StringBuilder();
        sb.Append("<table class=\"table table-hover table-bordered table-sm\" style=\"min-width: 1530px\">");
        if (mode == "xls") sb.Append(RenderExcelColumnHeader());
        else sb.Append(RenderColumnHeader(mode, sortCol, sortType));

        sb.Append("<tbody>");
        if (data != null && data.Tables.Count > 0 && data.Tables[0].Rows.Count > 0)
        {
            string strID = "";
            string strValue = "";
            string strPreVal = "";
            string strPreVal2 = "";
            int iRow = 1;

            foreach (DataRow row in data.Tables[0].Rows)
            {
                sb.AppendFormat("<tr class=\"\" id=\"_{0}\" csid=\"{1}\">", row["LcmID"].ToString(), row["CourseID"].ToString());

                for (int i = 0; i < _columnConfig.GetLength(0); i++)
                {
                    strID = _columnConfig[i, 0].ToString();
                    //strStyle = (mode != "xls" && i == _columnConfig.GetLength(0) - 1) ? "border-right:0" : "";

                    if (strID == "rownum")
                    {
                        strValue = row[strID].ToString();
                        if (row["ReqApvID"].ToString() == "0" && row["RepoApvID"].ToString() == "0") strValue = "<input name=\"ckbRow\" type=\"checkbox\" />";
                    }
                    else if (strID == "FromDate" || strID == "ToDate")
                    {
                        strValue = ZumNet.Web.Bc.CommonUtils.CheckDateTime(row[strID].ToString(), "MM-dd", "");
                    }
                    else if (strID == "CreateDate" || strID == "CompleteDate" || strID == "DeleteDate")
                    {
                        strValue = ZumNet.Web.Bc.CommonUtils.CheckDateTime(row[strID].ToString(), "MM-dd HH:mm", "");
                    }
                    else if (strID == "CourseDN")
                    {
                        strValue = row[strID].ToString();
                        if (mode != "xls" && strValue != "")
                        {
                            strValue = String.Format("<a class=\"z-lnk-navy-n\" href=\"javascript:\" onclick=\"_zw.fn.viewLcmInfo('LI', 'LCM_MAIN');\" title=\"{0}\">{0}</a>", strValue);
                        }
                    }
                    else if (strID == "ReqIFState") //신청상태
                    {
                        strValue = LcmState(row[strID].ToString(), row["IsCancel"].ToString());
                        if (strValue != "-")
                        {
                            if (row[strID].ToString() == "N")
                            {
                                //strValue = String.Format("<a href=\"javascript:\" onclick=\"showRegisterData(this, 'RI', 'LCM_MAIN');\" title=\"{0}\">{0}</a>", strValue);
                            }
                            else
                            {
                                if (mode != "xls")
                                    strValue = String.Format("<a class=\"z-lnk-navy-n\" href=\"javascript:\" onclick=\"_zw.fn.openEAFormSimple('{0}');\" title=\"\">{1}</a>", row["ReqApvID"].ToString(), strValue);
                            }
                        }
                    }
                    else if (strID == "RepoIFState") //결과보고상태
                    {
                        strValue = LcmState(row[strID].ToString(), "");
                        if (strValue != "-")
                        {
                            if (row[strID].ToString() == "N")
                            {
                                //strValue = String.Format("<a href=\"javascript:\" onclick=\"showRegisterData(this, 'PI', 'LCM_MAIN');\" title=\"{0}\">{0}</a>", strValue);
                            }
                            else
                            {
                                if (mode != "xls")
                                    strValue = String.Format("<a class=\"z-lnk-navy-n\" href=\"javascript:\" onclick=\"_zw.fn.openEAFormSimple('{0}');\" title=\"\">{1}</a>", row["RepoApvID"].ToString(), strValue);
                            }
                        }
                    }
                    else if (strID == "__NOTICEA__") //교육참석알림(3일)
                    {
                        if (row["IsCancel"].ToString() != "Y" && row["FromDate"].ToString() != "" && DateTime.Compare(Convert.ToDateTime(row["FromDate"]), DateTime.Now) > 0
                                && (row["ReqIFState"].ToString() == "N" || row["ReqIFState"].ToString() == "Y" || row["ReqIFState"].ToString() == "I"))
                        {
                            if (mode != "xls")
                                strValue = String.Format("<input id=\"ckbReq_{0}\" name=\"ckbReq\" type=\"checkbox\" /><label for=\"ckbReq_{0}\">{1}</label>"
                                    , row["LcmID"].ToString(), ZumNet.Web.Bc.CommonUtils.DateDiff(DateTime.Now.ToString("yyyy-MM-dd"), row["FromDate"].ToString()));
                            else
                                strValue = ZumNet.Web.Bc.CommonUtils.DateDiff(DateTime.Now.ToString("yyyy-MM-dd"), row["FromDate"].ToString()).ToString();
                        }
                        else
                        {
                            strValue = "-";
                        }
                    }
                    else if (strID == "__NOTICEB__") //과정변경알림
                    {
                        strValue = "-";
                    }
                    else if (strID == "__NOTICEC__") //결과보고요청(3일)
                    {
                        if (row["IsCancel"].ToString() != "Y" && row["ToDate"].ToString() != "" && DateTime.Compare(Convert.ToDateTime(row["ToDate"]), DateTime.Now) < 0
                                && (row["ReqIFState"].ToString() == "N" || row["ReqIFState"].ToString() == "Y")
                                && (row["RepoIFState"].ToString() == "-" || row["RepoIFState"].ToString() == "C" || row["RepoIFState"].ToString() == "R"))
                        {
                            if (mode != "xls")
                                strValue = String.Format("<input id=\"ckbRepo_{0}\" name=\"ckbRepo\" type=\"checkbox\" /><label for=\"ckbRepo_{0}\">{1}</label>"
                                    , row["LcmID"].ToString(), ZumNet.Web.Bc.CommonUtils.DateDiff(DateTime.Now.ToString("yyyy-MM-dd"), row["ToDate"].ToString()));
                            else
                                strValue = ZumNet.Web.Bc.CommonUtils.DateDiff(DateTime.Now.ToString("yyyy-MM-dd"), row["ToDate"].ToString()).ToString();
                        }
                        else
                        {
                            strValue = "-";
                        }
                    }
                    else if (strID == "_INST_") //교육기관, 강사
                    {
                        if (row["ClsCD1"].ToString() == "A20") strValue = row["InstDN"].ToString();
                        else strValue = row["InstructorInfo1"].ToString() + ". " + row["InstructorInfo2"].ToString() + ". " + row["Instructor"].ToString();
                    }
                    else if (strID == "ApplCorp")
                    {
                        strValue = row[strID].ToString();
                        if (strPreVal == strValue) strValue = "";
                        strPreVal = row["ApplCorp"].ToString();
                    }
                    else if (strID == "ApplDept")
                    {
                        strValue = row[strID].ToString();
                        if (strPreVal2 == strValue) strValue = "";
                        strPreVal2 = row["ApplDept"].ToString();
                    }
                    else
                    {
                        strValue = row[strID].ToString();
                    }

                    if (mode == "xls")
                    {
                        if (_columnConfig[i, 3].ToString() == "") sb.AppendFormat("<td style=\"text-align: center\">{0}</td>", strValue);
                        else sb.AppendFormat("<td style=\"text-align: {0}\">{1}</td>", _columnConfig[i, 3].ToString(), strValue);
                    }
                    else
                    {
                        if (_columnConfig[i, 3].ToString() == "") sb.AppendFormat("<td class=\"\">{0}</td>", strValue);
                        else sb.AppendFormat("<td class=\"text-{0}\">{1}</td>", _columnConfig[i, 3].ToString(), strValue);
                    }
                    strValue = "";
                }
                sb.Append("</tr>");
                iRow++;
            }
        }
        else
        {
            sb.Append("<tr>");
            sb.AppendFormat("<th colspan=\"{0}\" class=\"py-15\">{1}</th>", _columnConfig.GetLength(0), Resources.Global.NoItemShow);
            sb.Append("</tr>");
        }
        sb.Append("</tbody>");
        sb.Append("</table>");

        if (data != null) { data.Dispose(); data = null; }
        return sb.ToString();
    }

    private void ExcelBind(string data)
    {
        string strExcelFileName = "LCM_ADMIN_" + DateTime.Now.ToString("yyMMdd_HHmmss") + ".xls"; //2014-04-11
        Response.Clear();
        Response.Charset = "utf-8";
        Response.Buffer = true;
        //EnableViewState = false;
        Response.AddHeader("content-disposition", "attachment;filename=" + strExcelFileName); //Content.xls");
        Response.ContentType = "application/x-msdownload";
        string encoding = Request.ContentEncoding.HeaderName;
        Response.Write("<html xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\" xmlns=\"http://www.w3.org/TR/REC-html40\"><head>");
        Response.Write("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=" + encoding + "\">");
        Response.Write("<style type=\"text/css\">td {border:1px solid #c6c6c6}</style><head><body>");
        //Response.Write("<style type=\"text/css\">table {border:1px solid #c6c6c6} td {border-right:1px solid #c6c6c6;border-bottom:1px solid #c6c6c6}</style>");
        Response.Write(data);
        Response.Write("</body></html>");
    }

    private string LcmState(string state, string cancel)
    {
        if (cancel == "Y") return "취소";
        else
        {
            if (state == "N") return "일반등록";
            else if (state == "Y") return "완료";
            else if (state == "I") return "처리중";
            else if (state == "C") return "회수";
            else if (state == "R") return "반려";
            else return "-";
        }
    }
}

@Html.Raw(ViewList(ViewBag.Mode, ViewBag.BoardList, ViewBag.R.lv.sort.ToString(), ViewBag.R.lv.sortdir.ToString()))
