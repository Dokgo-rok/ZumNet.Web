@using System.Collections;
@using System.Data;
@using System.Text;

@using Newtonsoft.Json;

@{
    //Response.Write("-----------------------------" + ViewBag.BoardList.Tables[0].Rows.Count.ToString());
}
@functions {
    int _monthDay = 0;

    private string RenderColumnHeader(string mode, string sortCol, string sortType)
    {
        _monthDay = DateTime.DaysInMonth(Convert.ToInt32(ViewBag.R.lv.start.ToString().Substring(0, 4)), Convert.ToInt32(ViewBag.R.lv.start.ToString().Substring(4, 2)));
        //Response.Write("A=>" + _monthDay.ToString());

        string sBlind = "d-none";
        string sSortIcon = "";

        StringBuilder sb = new StringBuilder();
        sb.Append("<colgroup>");
        sb.AppendFormat("<col style=\"width:{0}\" />", "140px");
        sb.AppendFormat("<col style=\"width:{0}\" />", "40px");
        for (int i = 1; i <= _monthDay; i++)
        {
            sb.AppendFormat("<col style=\"width:{0}\" />", "35px");
        }
        sb.AppendFormat("<col style=\"width:{0}\" />", "40px");
        sb.Append("</colgroup>");

        sb.Append("<thead><tr class=\"table-success\">");

        if (mode == "xls")
        {
            sb.Append("<th class=\"xls_th\">MODEL</th>");
            sb.AppendFormat("<th class=\"xls_th\">{0}</th>", "구분");
            for (int i = 1; i <= _monthDay; i++)
            {
                sb.AppendFormat("<th class=\"xls_th\">{0}일</th>", i.ToString());
            }
            sb.AppendFormat("<th class=\"xls_th\">{0}</th>", "평균");
        }
        else
        {
            sBlind = (sortCol == "MODELCODE") ? "" : " d-none";
            sSortIcon = (sortType == "" || sortType == "ASC") ? "fe-arrow-up" : "fe-arrow-down";
            sb.AppendFormat("<th class=\"sortable text-truncate\"><a class=\"z-lnk-navy\" href=\"javascript:\" onclick=\"_zw.fn.sort('{0}');\" title=\"{1}\">{1}<i class=\"{2}{3} font-weight-bold\"></i></a></th>", "MODELCODE", "MODEL", sSortIcon, sBlind);

            sb.AppendFormat("<th class=\"text-truncate\">{0}</th>", "구분");

            for (int i = 1; i <= _monthDay; i++)
            {
                sb.AppendFormat("<th class=\"text-truncate\">{0}일</th>", i.ToString());
            }

            sb.AppendFormat("<th class=\"text-truncate\">{0}</th>", "평균");
        }
        sb.Append("</tr></thead>");
        return sb.ToString();
    }

    private string ViewList(string mode, DataSet data, string sortCol, string sortType)
    {
        StringBuilder sb = new StringBuilder();
        sb.Append("<table class=\"table table-hover table-bordered table-sm\" style=\"min-width: 1200px\">");
        sb.Append(RenderColumnHeader(mode, sortCol, sortType));

        sb.Append("<tbody>");
        if (data != null && data.Tables.Count > 0 && data.Tables[0].Rows.Count > 0)
        {
            DataRow[] rowQuery = null;
            DataRow[] rowQuery2 = null;

            string strStdTime = "";
            string strStdTime2 = "";
            string strManHour = ""; //일별 실적공수

            string strValue = "";
            string strDesc = "";
            int iSeq = 1;

            StringBuilder sb1 = new StringBuilder();
            StringBuilder sb2 = new StringBuilder();
            StringBuilder sb3 = new StringBuilder();

            foreach (DataRow row in data.Tables[0].Rows)
            {
                rowQuery = data.Tables[1].Select("MODELCODE = '" + row["MODELCODE"].ToString() + "'");
                rowQuery2 = data.Tables[2].Select("MODELCODE = '" + row["MODELCODE"].ToString() + "'");

                foreach (DataRow r in rowQuery)
                {
                    if (r["XCLS"].ToString() == "S") strStdTime = r["STDTIME"].ToString();
                    else if (r["XCLS"].ToString() == "R") strStdTime2 = r["STDTIME"].ToString();

                    if (r["BUYER"].ToString() != "" && r["ITEMCLS"].ToString() != "") strDesc = String.Format("<span style=\"color: #8a6d3b\">({0} / {1})</span>", r["BUYER"].ToString(), r["ITEMCLS"].ToString());
                }

                sb1.AppendFormat("<tr class=\"inner-dot\"><th rowspan=\"3\" class=\"xls_bold text-truncate\">{0}<br />{1}</th><td class=\"text-center\">표준</td>", row["MODELCODE"].ToString(), strDesc); //표준공수
                sb2.Append("<tr class=\"inner-dot\"><td style=\"text-align: center\">실적</td>"); //실적공수
                sb3.Append("<tr class=\"table-warning inner-bold\"><td class=\"xls_warning\" style=\"text-align: center\">차이</td>"); //차이 계산

                int iManHour = 0;
                decimal dManHour = 0;

                for (int i = 1; i <= _monthDay; i++)
                {
                    if (rowQuery2 != null)
                    {
                        foreach (DataRow r in rowQuery2)
                        {
                            if (r["TDAY"].ToString() == i.ToString())
                            {
                                strManHour = r["MAN_HOUR"].ToString(); break;
                            }
                        }
                    }

                    if (strManHour != "" && strManHour != "0")
                    {
                        iManHour++;
                        dManHour += Convert.ToDecimal(strManHour);

                        if (mode == "xls")
                        {
                            if (strStdTime == "" || strStdTime == "0") sb1.Append("<td>&nbsp;</td>");
                            else sb1.AppendFormat("<td>{0}</td>", ZumNet.Web.Bc.CommonUtils.CvtNumeric(strStdTime));
                            sb2.AppendFormat("<td>{0}</td>", ZumNet.Web.Bc.CommonUtils.CvtNumeric(strManHour));
                        }
                        else
                        {
                            if (strStdTime == "" || strStdTime == "0") sb1.Append("<td>&nbsp;</td>");
                            else sb1.AppendFormat("<td><a class=\"z-lnk-navy\" href=\"javascript:\" onclick=\"_zw.fn.viewListItem('D', null, '{0}', '{1}')\">{2}</a></td>", row["MODELCODE"].ToString(), i.ToString(), ZumNet.Web.Bc.CommonUtils.CvtNumeric(strStdTime));
                            sb2.AppendFormat("<td><a class=\"z-lnk-navy\" href=\"javascript:\" onclick=\"_zw.fn.viewListItem('D', null, '{0}', '{1}')\">{2}</a></td>", row["MODELCODE"].ToString(), i.ToString(), ZumNet.Web.Bc.CommonUtils.CvtNumeric(strManHour));
                        }

                        strValue = ZumNet.Web.Bc.CommonUtils.StrMinus(strManHour, strStdTime, 2);
                        if (strValue != "" && strValue.IndexOf('-') >= 0) strValue = "<strong class=\"text-danger\">(" + strValue.Replace("-", "") + ")</strong>";

                        sb3.AppendFormat("<td class=\"xls_warning\">{0}</td>", strValue);
                    }
                    else
                    {
                        sb1.Append("<td>&nbsp;</td>");
                        sb2.Append("<td>&nbsp;</td>");
                        sb3.Append("<td class=\"xls_warning\">&nbsp;</td>");
                    }
                    strManHour = "";
                    strValue = "";
                }

                if (iManHour > 0 && (strStdTime2 == "" || strStdTime2 == "0"))
                {
                    strStdTime2 = (dManHour / iManHour).ToString();
                }

                sb1.AppendFormat("<td>{0}</td></tr>", iManHour == 0 || strStdTime == "" || strStdTime == "0" ? "&nbsp;" : ZumNet.Web.Bc.CommonUtils.CvtNumeric(strStdTime));
                sb2.AppendFormat("<td>{0}</td></tr>", iManHour == 0 || strStdTime2 == "" || strStdTime2 == "0" ? "&nbsp;" : ZumNet.Web.Bc.CommonUtils.CvtNumeric(strStdTime2));

                strValue = ZumNet.Web.Bc.CommonUtils.StrMinus(strStdTime2, strStdTime, 2);
                if (strValue != "" && strValue.IndexOf('-') >= 0) strValue = "<strong class=\"text-danger\">(" + strValue.Replace("-", "") + ")</strong>";

                sb3.AppendFormat("<td class=\"xls_warning\">{0}</td></tr>", strStdTime2 == "" || strStdTime2 == "0" ? "&nbsp;" : strValue);

                sb.Append(sb1.ToString());
                sb.Append(sb2.ToString());
                sb.Append(sb3.ToString());

                sb1.Remove(0, sb1.Length);
                sb2.Remove(0, sb2.Length);
                sb3.Remove(0, sb3.Length);

                iSeq++;

                strStdTime = "";
                strStdTime2 = "";
                strManHour = "";
                rowQuery = null;
                rowQuery2 = null;
            }
            sb1 = null;
            sb2 = null;
            sb3 = null;
        }
        else
        {
            sb.Append("<tr>");
            sb.AppendFormat("<th colspan=\"{0}\" class=\"py-15\">{1}</th>", 50, Resources.Global.NoItemShow);
            sb.Append("</tr>");
        }
        sb.Append("</tbody>");
        sb.Append("</table>");

        if (data != null) { data.Dispose(); data = null; }

        return sb.ToString();
    }
}

@Html.Raw(ViewList(ViewBag.Mode, ViewBag.BoardList, ViewBag.R.lv.sort.ToString(), ViewBag.R.lv.sortdir.ToString()))