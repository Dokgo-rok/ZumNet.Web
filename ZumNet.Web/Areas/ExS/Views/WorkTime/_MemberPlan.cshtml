@using System.Collections;
@using System.Data;
@using System.Text;
@using Newtonsoft.Json;

@{

}

@functions {

    private int _tableWidth = 0;

    private string RenderColumnHeader(DataRowCollection colMember)
    {
        //일자(요일), 휴일, 부서원A,         부서원B,         부서원C
        //                  출퇴근계획/상태, 출퇴근계획/상태, 출퇴근계획/상태

        int iCnt = colMember.Count;

        StringBuilder sb = new StringBuilder();
        sb.Append("<colgroup>");
        sb.AppendFormat("<col style=\"width:{0}\" />", "100px");
        sb.AppendFormat("<col style=\"width:{0}\" />", "50px");
        foreach (DataRow row in colMember)
        {
            sb.AppendFormat("<col style=\"width:{0}\" />", "30px");
            sb.AppendFormat("<col style=\"width:{0}\" />", "100px");
            sb.AppendFormat("<col style=\"width:{0}\" />", "100px");
        }
        sb.Append("</colgroup>");

        _tableWidth = 150 + (230 * colMember.Count);

        sb.Append("<thead><tr>");
        sb.AppendFormat("<th rowspan=\"2\">{0}</th>", "일자");
        sb.AppendFormat("<th rowspan=\"2\">{0}</th>", "휴일");

        foreach (DataRow row in colMember)
        {
            sb.AppendFormat("<th colspan=\"3\" data-for=\"{0}\">{1}</th>", row["UserID"].ToString(), row["DisplayName"].ToString());
        }

        sb.Append("</tr><tr>");

        foreach (DataRow row in colMember)
        {
            sb.AppendFormat("<th><input type='checkbox' id='chkHeader' onClick='checkAll(this)' hidefocus data-for=\"{0}\" /></th>", row["UserID"].ToString());
            sb.AppendFormat("<th>{0}</th>", "출퇴근계획");
            sb.AppendFormat("<th>{0}</th>", "상태");
        }

        sb.Append("</tr></thead>");
        return sb.ToString();
    }

    private string ViewList(string mode, DataSet data, DataRowCollection colMember, DataRowCollection hDay)
    {
        string strHeader = RenderColumnHeader(colMember);

        StringBuilder sb = new StringBuilder();
        sb.AppendFormat("<table class=\"table table-bordered table-sm\" style=\"width:{0}px; max-width:{0}px\">", _tableWidth.ToString());
        sb.Append(strHeader);

        sb.Append("<tbody>");
        if (data != null && data.Tables.Count > 0 && data.Tables[0].Rows.Count > 0)
        {
            string strID = "";
            string strValue = "";
            string strClass = "";
            string strHoliday = "";
            int iHour = 0;
            int iMin = 0;
            bool bHoliday = false;

            foreach (DataRow row in data.Tables[0].Rows)
            {
                DateTime dPlan = Convert.ToDateTime(row["MDate"]);
                strHoliday = StrHoliday(hDay, dPlan);

                if (strHoliday != "" || dPlan.DayOfWeek == DayOfWeek.Sunday) { strClass = " class=\"table-danger\""; bHoliday = true; }
                else if (dPlan.DayOfWeek == DayOfWeek.Saturday) { strClass = " class=\"table-info\""; bHoliday = true; }
                else { strClass = ""; bHoliday = false; }

                sb.AppendFormat("<tr{0}>", strClass);
                sb.AppendFormat("<th>{0} ({1})</th>", dPlan.ToString("MM-dd"), row["WDay"].ToString());
                sb.AppendFormat("<td>{0}</td>", (bHoliday) ? "휴일" : "&nbsp;");

                foreach (DataRow dr in colMember)
                {
                    DataRow[] q = data.Tables[1].Select("UserID = " + dr["UserID"].ToString() + " AND PlanDate = '" + row["MDate"].ToString() + "'");
                    if (q != null && q.Length > 0)
                    {
                        sb.AppendFormat("<td><input name=\"ckbRow\" type=\"checkbox\" data-for=\"{0}\" data-zf-field=\"{1}\" value=\"{2}\"{3} />"
                            , dr["UserID"].ToString(), "RegID", q[0]["RegID"].ToString(), (q[0]["Status"].ToString() != "1" ? " disabled" : ""));
                        sb.AppendFormat("<input type=\"hidden\" data-zf-field=\"{0}\" value=\"{1}\" />", "PlanDate", q[0]["PlanDate"].ToString());
                        sb.AppendFormat("<input type=\"hidden\" data-zf-field=\"{0}\" value=\"{1}\" />", "PlanInTime", q[0]["PlanInTime"].ToString());
                        sb.AppendFormat("<input type=\"hidden\" data-zf-field=\"{0}\" value=\"{1}\" />", "PlanOutTime", q[0]["PlanOutTime"].ToString());
                        sb.AppendFormat("<input type=\"hidden\" data-zf-field=\"{0}\" value=\"{1}\" />", "Status", q[0]["Status"].ToString());
                        sb.Append("</td>");
                        sb.AppendFormat("<td>{0} ~ {1}</td>", q[0]["PlanInTime"].ToString(), q[0]["PlanOutTime"].ToString());
                        sb.AppendFormat("<td>{0}</td>", StrStatus(q[0]["Status"].ToString(), "Status"));
                    }
                    else
                    {
                        sb.Append("<td>&nbsp;</td>");
                        sb.Append("<td>&nbsp;</td>");
                        sb.Append("<td>&nbsp;</td>");
                    }
                }

                sb.Append("</tr>");
            }
        }
        else
        {
            sb.Append("<tr>");
            sb.AppendFormat("<th colspan=\"{0}\">{1}</th>", 10, Resources.Global.NoItemShow);
            sb.Append("</tr>");
        }
        sb.Append("</tbody>");
        sb.Append("</table>");

        if (data != null) { data.Dispose(); data = null; }

        return sb.ToString();
    }

    #region [유틸]
    private string StrHoliday(DataRowCollection holiday, DateTime d)
    {
        if (holiday != null && holiday.Count > 0)
        {
            foreach (DataRow dr in holiday)
            {
                if (dr["Item2"].ToString() == "Y" && dr["ItemSubHandler"].ToString() == d.ToString("yyyyMMdd"))
                {
                    return dr["Item1"].ToString();
                }
            }
        }
        return "";
    }

    private string StrPlanType(bool holiday, string pt, string fld)
    {
        StringBuilder sb = new StringBuilder();


        if (holiday)
        {
            sb.Append(zfInput("휴일", fld, "", "", "center", true));
        }
        else
        {
            sb.AppendFormat("<select class=\"custom-select z-select\" data-zf-field=\"{0}\">", fld);
            sb.AppendFormat("<option value=\"{0}\">{0}</option>", "일반");
            sb.AppendFormat("<option value=\"{0}\">{0}</option>", "프로젝트");
            sb.AppendFormat("<option value=\"{0}\">{0}</option>", "재택");
            sb.Append("</select>");
        }


        return sb.ToString();
    }

    private string StrStatus(string ss, string fld)
    {
        StringBuilder sb = new StringBuilder();

        if (ss == "7")
        {
            sb.Append("승인");
        }
        else if (ss == "8")
        {
            sb.Append("재검토");
        }
        else
        {
            sb.AppendFormat("<select class=\"custom-select z-select\" data-zf-field=\"{0}\">", fld);
            //sb.AppendFormat("<option value=\"0\"{0}>{1}</option>", (ss == "0" ? " selected" : ""), "저장");
            sb.AppendFormat("<option value=\"1\"{0}>{1}</option>", (ss == "1" ? " selected" : ""), "승인대기");
            sb.AppendFormat("<option value=\"7\"{0}>{1}</option>", (ss == "7" ? " selected" : ""), "승인");
            sb.AppendFormat("<option value=\"8\"{0}>{1}</option>", (ss == "8" ? " selected" : ""), "재검토");
            sb.Append("</select>");
        }

        return sb.ToString();
    }

    public static string zfInput(string v)
    {
        return zfInput(v, "");
    }

    public static string zfInput(string v, string df)
    {
        return zfInput(v, df, "", "");
    }

    public static string zfInput(string v, string df, string id, string nm)
    {
        return zfInput(v, df, id, nm, "", false);
    }

    public static string zfInput(string v, string df, string id, string nm, string align, bool read)
    {
        df = (df != "") ? " data-zf-field=\"" + df + "\"" : "";
        id = (id != "") ? " id=\"" + id + "\"" : "";
        nm = (nm != "") ? " name=\"" + nm + "\"" : "";

        string sClass = "";
        if (align == "center") sClass = " text-center";
        else if (align == "right") sClass = " text-right";

        sClass += (read) ? " z-read" : "";

        return String.Format("<input type=\"text\" value=\"{0}\"{1}{2}{3} class=\"z-input{4}\"{5} />", v, df, id, nm, sClass, (read) ? " readonly" : "");
    }
    #endregion
}

@Html.Raw(ViewList(ViewBag.R.mode.ToString(), ViewBag.BoardList, ViewBag.Member, ViewBag.Holiday))