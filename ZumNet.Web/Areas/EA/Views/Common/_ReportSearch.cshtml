@using System;
@using System.Collections;
@using System.Collections.Generic;
@using System.Data;
@using System.IO;
@using System.Text;
@using Newtonsoft.Json;
@using Newtonsoft.Json.Linq;
@using ZumNet.BSL.ServiceBiz;
@using ZumNet.BSL.InterfaceBiz;
@using ZumNet.Web.Bc;
@using ZumNet.Framework.Core;
@using ZumNet.Framework.Exception;
@using ZumNet.Framework.Util;
@functions{
    private string GetReportSearch(JObject postData)
    {
        ServiceResult svcRt = new ServiceResult();
        string strBodyMode = postData.ContainsKey("body") ? postData["body"].ToString() : ""; // S(문자열반환), N(modal-body 없음), F(footer 포함)
        string strReturn = "";

        char cDel = (char)8;
        int iTotal = 0;
        int iTotalPage = 0;
        int iPage = 1;
        int iPageCount = 50;

        try
        {
            if (postData.ContainsKey("page")) iPage = Convert.ToInt32(postData["page"].ToString());
            if (postData.ContainsKey("iPageCount")) iPage = Convert.ToInt32(postData["count"].ToString());

            if (strBodyMode == "S")
            {
                string strRt = "";
                if (postData["k2"].ToString() == "REGISTER_OUTWORK" || postData["k2"].ToString() == "REGISTER_INANDOUT")
                {
                    #region [야근신청서]
                    if (postData["query"].ToString() == "")
                    {
                        strReturn = "NE" + "근무일자가 누락됐습니다!";
                    }
                    else
                    {
                        using (ReportBiz rptBiz = new ReportBiz())
                        {
                            svcRt = rptBiz.GetReport("ua", Convert.ToInt32(postData["query"].ToString()), postData["k2"].ToString(), postData["v1"].ToString(), "", "", "", "", "", "");
                        }

                        if (svcRt.ResultCode == 0)
                        {
                            if (svcRt.ResultItemCount > 0) strRt = svcRt.ResultDataSet.Tables[0].Rows[0]["STDTIME"].ToString();
                            if (strRt == "") strReturn = "ND";
                            else strReturn = "OK" + strRt;
                        }
                        else strReturn = svcRt.ResultMessage;
                    }
                    #endregion
                }
                else
                {
                    strReturn = "해당 조건이 누락됐습니다!";
                }
            }
            else
            {
                StringBuilder sb = new StringBuilder();

                if (strBodyMode != "N")
                {
                    sb.Append("<div class=\"zf-modal modal-dialog modal-dialog-centered modal-dialog-scrollable modal-sm\">");
                    sb.AppendFormat("<div class=\"modal-content\" data-for=\"{0}\" style=\"box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.5)\">", postData["k2"].ToString());
                    sb.Append("<div class=\"modal-header\">");
                    sb.Append("<h5 class=\"modal-title\"></h5>");
                    sb.Append("<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>");
                    //sb.AppendFormat("<input type=\"hidden\" data-for=\"param\" value=\"{0}\" />", postData["param"].ToString());
                    sb.Append("</div>");
                    sb.Append("<div class=\"modal-body\">"); //modal-body
                }

                if (postData["k2"].ToString() == "SEARCH_NEWDEVREQMODEL")
                {
                    using (ReportBiz rptBiz = new ReportBiz())
                    {
                        svcRt = rptBiz.GetReport("", 0, postData["k2"].ToString(), "", "", "", "", "", "", "", iPage, iPageCount, "", "", "", postData["search"].ToString());
                    }

                    if (svcRt.ResultCode == 0)
                    {
                        iTotal = svcRt.ResultItemCount;
                        iTotalPage = iTotal / iPageCount + 1;

                        if (svcRt.ResultItemCount > 0)
                        {
                            sb.AppendFormat("<span class=\"mr-2\">총 {0}개 {1}/{2} 페이지</span>", iTotal.ToString(), iPage.ToString(), iTotalPage.ToString());
                            if (iPage > 1) sb.AppendFormat("<button class=\"btn btn-primary btn-sm icon-btn mr-1\" title=\"{0}페이지\" data-for=\"{0}\"><i class=\"fe-chevron-left\"></i></button>", (iPage - 1).ToString());
                            if (iPage < iTotalPage) sb.AppendFormat("<button class=\"btn btn-primary btn-sm icon-btn mr-1\" title=\"{0}페이지\" data-for=\"{0}\"><i class=\"fe-chevron-right\"></i></button>", (iPage + 1).ToString());
                            sb.Append(cDel); //페이징과 테이블 구분

                            sb.Append("<table class=\"table table-striped table-sm mb-0\">");
                            sb.Append("<colgroup><col width=\"45%\" /><col width=\"55%\" /></colgroup>");
                            sb.Append("<thead>");
                            sb.Append("<tr><th>모델명</th><th>품명</th></tr>");
                            sb.Append("</thead>");
                            sb.Append("<tbody>");
                            foreach (DataRow row in svcRt.ResultDataSet.Tables[0].Rows)
                            {
                                sb.Append("<tr>");
                                sb.AppendFormat("<td><a class=\"z-lnk-navy\" href=\"javascript:void(0)\" data-val=\"{0}^{1}\">{0}</a></td>", row["MODELNAME"].ToString().Trim(), row["ITEMNAME"].ToString().Trim());
                                sb.AppendFormat("<td>{0}</td>", row["ITEMNAME"].ToString().Trim());
                                sb.AppendFormat("</tr>");
                            }
                            sb.Append("</tbody>");
                            sb.Append("</table>");
                        }
                        else
                        {
                            sb.Append(cDel);
                            sb.AppendFormat("<div class=\"text-center mt-3 h5 text-secondary\">{0}</div>", Resources.Global.NoItemShow);
                        }
                    }
                    else
                    {
                        strReturn = svcRt.ResultMessage;
                    }
                }
                else if (postData["k2"].ToString() == "FORM_VACATIONCHANGE")
                {
                    #region [사전휴가신청 목록]
                    using (ReportBiz rptBiz = new ReportBiz())
                    {
                        svcRt = rptBiz.GetReport("", Convert.ToInt32(postData["query"].ToString()), postData["k2"].ToString(), "", "", "", "", "", "", "");
                    }

                    if (svcRt.ResultCode == 0)
                    {
                        if (svcRt.ResultItemCount > 0)
                        {
                            sb.Append("<table class=\"table table-striped table-sm text-center mb-0\">");
                            sb.Append("<colgroup><col width=\"25%\" /><col width=\"15%\" /><col width=\"15%\" /><col width=\"15%\" /><col width=\"30%\" /></colgroup>");
                            sb.Append("<thead>");
                            sb.Append("<tr><th>휴가일</th><th>휴가구분</th><th>시작시각</th><th>휴가갯수</th><th>등록일</th></tr>");
                            sb.Append("</thead>");
                            sb.Append("<tbody>");
                            //foreach (DataRow row in svcRt.ResultDataSet.Tables[0].Rows)
                            for (int i = svcRt.ResultDataSet.Tables[0].Rows.Count - 1; i >= 0; i--)
                            {
                                DataRow row = svcRt.ResultDataSet.Tables[0].Rows[i];
                                sb.Append("<tr>");
                                sb.Append("<td>");
                                sb.Append("<label class=\"custom-control custom-checkbox mb-0\"><input type=\"checkbox\" class=\"custom-control-input\" />");
                                sb.AppendFormat("<span class=\"custom-control-label\">{0}</span>", row["LeaveDate"].ToString());
                                sb.Append("</label>");
                                sb.AppendFormat("<input type=\"hidden\" data-for=\"TGID\" value=\"{0}\" />", row["ObjectID"].ToString());
                                sb.AppendFormat("<input type=\"hidden\" data-for=\"TGVACCLASS\" value=\"{0}\" />", row["LeaveClass"].ToString());
                                sb.AppendFormat("<input type=\"hidden\" data-for=\"TGMSG\" value=\"{0}\" />", row["RelatedMsg"].ToString());
                                sb.AppendFormat("<input type=\"hidden\" data-for=\"TGDATE\" value=\"{0}\" />", DateHelper.CheckDateTime(row["EventDate"].ToString(), "yyyy-MM-dd HH:mm"));
                                sb.Append("</td>");
                                sb.AppendFormat("<td>{0}</td>", row["LeaveDN"].ToString());
                                sb.AppendFormat("<td>{0}</td>", row["LeaveFromTime"].ToString());
                                sb.AppendFormat("<td>{0}</td>", row["LeaveCount"].ToString());
                                sb.AppendFormat("<td><a class=\"z-lnk-navy\" href=\"javascript:void(0)\" onclick=\"_zw.fn.openEAFormSimple('{0}')\">{1}</a></td>"
                                            , row["RelatedMsg"].ToString(), DateHelper.CheckDateTime(row["EventDate"].ToString(), "yyyy-MM-dd HH:mm"));
                                sb.AppendFormat("</tr>");
                            }
                            sb.Append("</tbody>");
                            sb.Append("</table>");
                        }
                        else
                        {
                            sb.AppendFormat("<div class=\"text-center mt-3 h5 text-secondary\">{0}</div>", Resources.Global.NoItemShow);
                        }
                    }
                    else
                    {
                        sb.AppendFormat("<div class=\"text-center mt-3 h5 text-secondary\">{0}</div>", svcRt.ResultMessage);
                    }
                    #endregion
                }
                else if (postData["k2"].ToString().IndexOf("ERP_") != -1)
                {
                    #region ["ERP_" 시작]
                    using (ReportBiz rptBiz = new ReportBiz())
                    {
                        svcRt = rptBiz.GetReportERP("", 0, postData["k2"].ToString(), "", "", postData["search"].ToString(), postData["v1"].ToString(), "", "", "");
                    }

                    if (svcRt.ResultCode == 0)
                    {
                        if (svcRt.ResultItemCount > 0)
                        {
                            sb.Append("<table class=\"table table-striped table-sm text-center mb-0\">");
                            sb.Append("<colgroup><col width=\"45%\" /><col width=\"55%\" /></colgroup>");
                            sb.Append("<thead>");
                            sb.Append("<tr><th>코드</th><th>설명</th></tr>");
                            sb.Append("</thead>");
                            sb.Append("<tbody>");
                            foreach (DataRow row in svcRt.ResultDataSet.Tables[0].Rows)
                            {
                                sb.Append("<tr>");
                                sb.AppendFormat("<td><a class=\"z-lnk-navy\" href=\"javascript:void(0)\" data-val=\"{1}^{0}\">{0}</a></td>", row["ITEM1"].ToString(), row["ITEM2"].ToString());
                                sb.AppendFormat("<td>{0}</td>", row["ITEM2"].ToString());
                                sb.AppendFormat("</tr>");
                            }
                            sb.Append("</tbody>");
                            sb.Append("</table>");
                        }
                        else
                        {
                            sb.AppendFormat("<div class=\"text-center mt-3 h5 text-secondary\">{0}</div>", Resources.Global.NoItemShow);
                        }
                    }
                    else
                    {
                        strReturn = svcRt.ResultMessage;
                    }
                    #endregion
                }
                else
                {
                    strReturn = "해당 조건이 누락됐습니다!";
                }

                if (strBodyMode != "N")
                {
                    sb.Append("</div>");

                    if (strBodyMode == "F")
                    {
                        sb.Append("<div class=\"modal-footer\">"); //modal-footer
                        sb.Append("<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">닫기</button>");
                        sb.Append("<button type=\"button\" class=\"btn btn-primary\" data-zm-menu=\"confirm\">확인</button>");
                        sb.Append("</div>");
                    }

                    sb.Append("</div>"); //content
                    sb.Append("</div>");
                }
                if (strReturn == "") strReturn = "OK" + sb.ToString();
            }
        }
        catch (Exception ex)
        {
            ExceptionManager.Publish(ex, ExceptionManager.ErrorLevel.Error, "GetReportSearch");
            strReturn = (strReturn != "" ? "[" + strReturn + "] " : "") + ex.Message;
        }
        finally
        {
        }
        return strReturn;
    }
}
@Html.Raw(GetReportSearch(ViewBag.JPost))