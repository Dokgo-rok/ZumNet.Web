@using System.Collections;
@using System.Data;
@using System.Text;
@using System.Threading;
@using Newtonsoft.Json;

@{
    //4M변경관리현황, FORM_BIZTRIPPLAN

    ConfigColumn();

    //Response.Write("=======" + ViewBag.R.lv.cd1.ToString());
}

@functions {

    string[,] _columnConfig = null;
    string _tblWidth = "";

    private void ConfigColumn()
    {
        //크레신 : 신개의현황 2014-05-09
        string[,] arr = { { "SEQ", "NO", "40px", "", "" }, { "CUSTOMER", "고객명", "150px", "L", "Y" }, { "ITEMNAME", "품명", "150px", "L", "Y" }
                            , { "MODELNAME", "모델명", "150px", "L", "Y" }, { "GRADE", "개발<br />등급", "50px", "", "Y" }, { "SALEPRICE", "판매<br />목표가<br />(USD)", "75px", "", "" }, { "DEVPRICEA", "재료비", "75px", "", "" }
                            , { "DEVPRICEBA", "내작", "75px", "", "" }, { "DEVPRICEBB", "외주", "75px", "", "" }, { "DEVPRICEC", "관리비", "75px", "", "" }
                            , { "DEVELOPPRICE", "TOTAL", "75px", "", "" }, { "PREDICTRATE", "예상<br />이익율(%)", "75px", "", "" }, {"PLANCOUNT", "기획<br />수량", "75px", "", ""}
                            , { "PREDICTPROFIT", "총예상<br />이익<br />(USD)", "75px", "", "" }, {"PREDICTINVEST", "예상<br />투자비<br />(USD)", "75px", "", ""}, {"PRODUCTCENTER", "생산지", "75px", "", "Y"}
                            , { "PublishDate", "등록일자", "100px", "", "Y" }, { "DocStatus", "결재상태", "100px", "", "" }}; //1565
        this._columnConfig = arr;
        this._tblWidth = "1565px";
    }

    private string RenderColumnHeader(string mode)
    {
        string strValue = "";
        StringBuilder sb = new StringBuilder();

        sb.AppendFormat("<colgroup span=\"{0}\">", _columnConfig.GetLength(0));
        for (int i = 0; i < _columnConfig.GetLength(0); i++)
        {
            sb.AppendFormat("<col style=\"width:{0}\" />", _columnConfig[i, 2].ToString());
        }
        sb.Append("</colgroup>");

        sb.Append("<thead>");
        sb.Append("<tr class=\"table-success\">");
        for (int i = 0; i <= 5; i++)
        {
            if (_columnConfig[i, 4].ToString() == "Y") strValue = String.Format("<a class=\"z-lnk-navy\" href=\"javascript:\" onclick=\"_zw.fn.sort();\">{0}</a>", _columnConfig[i, 1].ToString());
            else strValue = _columnConfig[i, 1].ToString();
            sb.AppendFormat("<th id=\"f_{0}\" rowspan=\"3\">{1}</th>", _columnConfig[i, 0].ToString(), strValue);
        }
        sb.Append("<th colspan=\"5\">개발견적가(USD)</th>");
        for (int i = 11; i < _columnConfig.GetLength(0); i++)
        {
            if (_columnConfig[i, 4].ToString() == "Y")
            {
                strValue = String.Format("<a class=\"z-lnk-navy\" href=\"javascript:\" onclick=\"_zw.fn.sort();\">{0}</a>", _columnConfig[i, 1].ToString());
            }
            else
            {
                strValue = _columnConfig[i, 1].ToString();
            }
            sb.AppendFormat("<th id=\"f_{0}\" rowspan=\"3\">{1}</th>", _columnConfig[i, 0].ToString(), strValue);
        }
        sb.Append("</tr>");
        sb.Append("<tr class=\"table-success\">");
        sb.AppendFormat("<th id=\"f_{0}\" rowspan=\"2\">{1}</th>", _columnConfig[6, 0].ToString(), _columnConfig[6, 1].ToString());
        sb.Append("<th colspan=\"2\">가공비</th>");
        sb.AppendFormat("<th id=\"f_{0}\" rowspan=\"2\">{1}</th>", _columnConfig[9, 0].ToString(), _columnConfig[9, 1].ToString());
        sb.AppendFormat("<th id=\"f_{0}\" rowspan=\"2\">{1}</th>", _columnConfig[10, 0].ToString(), _columnConfig[10, 1].ToString());
        sb.Append("</tr>");
        sb.Append("<tr class=\"table-success\">");
        sb.AppendFormat("<th id=\"f_{0}\">{1}</th>", _columnConfig[7, 0].ToString(), _columnConfig[7, 1].ToString());
        sb.AppendFormat("<th id=\"f_{0}\">{1}</th>", _columnConfig[8, 0].ToString(), _columnConfig[8, 1].ToString());
        sb.Append("</tr>");

        sb.Append("</thead>");
        return sb.ToString();
    }

    private string ViewList(string mode, DataSet data)
    {
        if (data != null && data.Tables.Count > 0)
        {
            string strID = "";
            string strValue = "";
            int iRow = 1;

            StringBuilder sb = new StringBuilder();
            sb.AppendFormat("<table class=\"table table-hover table-bordered table-sm\" style=\"width:{0}\">", this._tblWidth);
            sb.Append(RenderColumnHeader(mode));
            sb.Append("<tbody>");

            foreach (DataRow row in data.Tables[0].Rows)
            {
                sb.AppendFormat("<tr id=\"_{0}\">", row["MessageID"].ToString());

                for (int i = 0; i < _columnConfig.GetLength(0); i++)
                {
                    strID = _columnConfig[i, 0].ToString();

                    if (strID.ToUpper() == "SEQ")
                    {
                        strValue = iRow.ToString();
                    }
                    else if (strID == "PublishDate")
                    {
                        strValue = ZumNet.Web.Bc.CommonUtils.LvDate(row[strID].ToString());
                    }
                    else if (strID == "MODELNAME")
                    {
                        strValue = "<a class=\"z-lnk-navy\" href=\"javascript:\" onclick=\"_zw.fn.openXForm();\">" + row[strID].ToString() + "</a>";
                    }
                    else if (strID == "DocStatus")
                    {
                        if (ViewBag.DocStatus == null) strValue = row[strID].ToString();
                        else strValue = StrDocStatus(row[strID].ToString());
                    }
                    else
                    {
                        strValue = row[strID].ToString();
                    }
                    strValue = (strValue.Trim() == "") ? "&nbsp;" : strValue;

                    sb.AppendFormat("<td class=\"{0}\">{1}</td>", _columnConfig[i, 3].ToString() == "L" ? "text-left" : "", strValue);
                }
                sb.Append("</tr>");
                iRow++;
            }
            sb.Append("</tbody>");
            sb.Append("</table>");

            return sb.ToString();
        }
        return "";
    }

    private string StrDocStatus(string ss)
    {
        foreach (DataRow row in ViewBag.DocStatus)
        {
            if (row["ItemSubHandler"].ToString() == ss)
            {
                string sCurrentLocale = Thread.CurrentThread.CurrentUICulture.Name;

                if (sCurrentLocale.ToLower().IndexOf("ko") >= 0) return row["Item1"].ToString();
                else if (sCurrentLocale.ToLower().IndexOf("zh") >= 0) return row["Item3"].ToString();
                else return row["Item2"].ToString();
            }
        }
        return ss;
    }

    private string ListCount()
    {
        string sPage = "";
        int totalCount = 0;
        if (ViewBag.R.ft.ToString() == "___")
        {
            int maxPage = ZumNet.Web.Bc.CommonUtils.IsMobile() ? 5 : 10;
            totalCount = Convert.ToInt32(ViewBag.R.lv.total.Value);
            int pageCount = Convert.ToInt32(ViewBag.R.lv.count.Value);
            int pageIndex = Convert.ToInt32(ViewBag.R.lv.page.Value);
            int totalPage = totalCount / pageCount;

            if (totalCount % pageCount > 0) { totalPage++; }
            if (pageIndex > totalPage) { pageIndex = totalPage; }

            sPage = String.Format("{0} {1} {2} ({3} / {4} {5})", Resources.Global.Total, totalCount.ToString(), Resources.Global.Count, pageIndex.ToString(), totalPage.ToString(), Resources.Global.Page);

        }
        else
        {
            totalCount = Convert.ToInt32(ViewBag.R.lv.total.Value);
            sPage = String.Format("{0} {1} {2}", Resources.Global.Total, totalCount.ToString(), Resources.Global.Count);
        }

        return sPage;
    }

    private string ListCond()
    {
        string swidth = _columnConfig != null && _columnConfig.GetLength(0) > 0 ? " wwd-md-80 wd-lg-70 wd-xl-60" : " wd-sm-80 wd-md-60 wd-lg-45 wd-xl-40";

        StringBuilder sb = new StringBuilder();

        sb.AppendFormat("<div class=\"z-list-cond d-flex justify-content-end wd-70{0}\">", swidth);

        sb.Append("<div class=\"z-list-date input-group datepicker input-daterange\">");
        sb.AppendFormat("<input type=\"text\" class=\"form-control start-date px-1\" value=\"{0}\">", ViewBag.R.lv.start);
        sb.Append("<div class=\"input-group-prepend\">");
        sb.Append("<span class=\"input-group-text\">~</span>");
        sb.Append("</div>");
        sb.AppendFormat("<input type=\"text\" class=\"form-control end-date px-1\" value=\"{0}\">", ViewBag.R.lv.end);
        sb.AppendFormat("<div class=\"input-group-append{0}\">", _columnConfig != null && _columnConfig.GetLength(0) > 0 ? "  d-flex d-sm-none" : "");
        sb.Append("<button class=\"btn btn-secondary\" type=\"button\" data-zv-menu=\"search\"><i class=\"fe-search\"></i></button>");
        sb.Append("</div>");
        sb.Append("</div>");

        if (_columnConfig != null && _columnConfig.GetLength(0) > 0)
        {
            sb.Append("<div class=\"z-list-search input-group d-none d-sm-flex\">");
            sb.Append("<select class=\"custom-select ml-1\" id=\"_SearchSelect\">");
            sb.AppendFormat("<option value=\"\">{0}..</option>", Resources.Global.Select);
            for (int i = 0; i < _columnConfig.GetLength(0); i++)
            {
                if (_columnConfig[i, 4].ToString() == "Y")
                {
                    sb.AppendFormat("<option value=\"{0}\"{2}>{1}</option>", _columnConfig[i, 0].ToString(), _columnConfig[i, 1].ToString(), _columnConfig[i, 0].ToString() == ViewBag.R.lv.cd1.ToString() ? " selected" : "");
                }

            }
            sb.Append("</select>");
            sb.AppendFormat("<input type=\"text\" class=\"form-control\" id=\"_SearchText\" placeholder=\"{0}\" value=\"{1}\">", Resources.Global.Search, ViewBag.R.lv.cd2.ToString());

            sb.Append("<span class=\"input-group-append\">");
            sb.Append("<button class=\"btn btn-secondary\" type=\"button\" data-zv-menu=\"search\"><i class=\"fe-search\"></i></button>");
            sb.Append("</span>");
            sb.Append("</div>");
        }

        sb.Append("</div>"); //z-list-cond
        return sb.ToString();
    }
}

<div class="z-list-head d-flex justify-content-between my-2">
    <div class="z-list-page d-flex align-items-center" id="__ListCount">
        <div class="z-list-total mt-1 mr-1">
            <i class="fe-chevron-right"></i> @ListCount()
        </div>
    </div>
    @Html.Raw(ListCond())
</div>

<div class="z-list-body" id="__ListView">
    @Html.Raw(ViewList(ViewBag.R.mode.ToString(), ViewBag.BoardList))
</div>

