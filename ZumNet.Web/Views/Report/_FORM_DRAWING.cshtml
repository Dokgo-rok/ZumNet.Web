@using System.Collections;
@using System.Data;
@using System.Text;
@using System.Threading;
@using Newtonsoft.Json.Linq;
@using ZumNet.Framework.Util;
@using ZumNet.Web.Bc;
@using ZumNet.Web.Filter;
@{
    //FORM_PURCHASEUCLIST
    InitConfig();

    ZumNet.Framework.Core.ServiceResult svcRt = null;
    if (ViewBag.R.lv.cd1.ToString() == "A")
    {
        using (ZumNet.BSL.InterfaceBiz.OracleBiz oraBiz = new ZumNet.BSL.InterfaceBiz.OracleBiz())
        {
            svcRt = oraBiz.Cresyn_Get_CBO_BOM_ITEMS("107", ViewBag.R.lv.cd2.ToString());
        }
    }
    else if (ViewBag.R.lv.cd1.ToString() == "B")
    {
        using (ZumNet.BSL.InterfaceBiz.ReportBiz rpBiz = new ZumNet.BSL.InterfaceBiz.ReportBiz())
        {
            svcRt = rpBiz.GetReport(ViewBag.R.mode.ToString(), 0, ViewBag.R.ft.ToString(), "", "", ViewBag.R.lv.cd2.ToString(), "", "", "", "");
        }
    }

    if (svcRt != null && svcRt.ResultCode == 0)
    {
        ViewBag.R.lv["total"] = svcRt.ResultItemCount.ToString();
    }
    else
    {
        ViewBag.R.lv["total"] = 0;
    }

    if (ViewBag.R.mode == "xls")
    {
        ExcelBind(ViewList(ViewBag.R.mode.ToString(), svcRt.ResultDataSet));
        Response.End();
    }
}
@functions {
    string[,] _columnConfig = null;
    string _tblWidth = "";

    private void InitConfig()
    {
        //초기 설정
        //if (ViewBag.R.lv.start == "") ViewBag.R.lv["start"] = DateTime.Now.AddMonths(-1).ToString("yyyy-MM-dd"); //최근 1개월
        if (ViewBag.R.ttl == "") ViewBag.R["ttl"] = "도면MASTER리스트";

        //검색조건 설정

        //크레신 : 구매단가결정현황 20-02-24
        string[,] arr = {
        { "SEQ", "NO", "4%", "", "" }, { "PLAN_LEVEL", "수준", "6%", "L", "Y" }, { "ITEM_CODE", "부품번호", "28%", "L", "" },
        { "ITEM_NAME", "부품명", "34%", "L", "" }, { "__LINK1__", "도면등록서", "14%", "", "" }, { "__LINK2__", "부품승인사양서", "14%", "", "" }
            };
        this._columnConfig = arr;
        this._tblWidth = "100%";
    }

    private string RenderColumnHeader(string mode)
    {
        StringBuilder sb = new StringBuilder();
        string sClassExcel = mode == "xls" ? " class=\"xls_th\"" : "";

        sb.AppendFormat("<colgroup span=\"{0}\">", _columnConfig.GetLength(0));
        for (int i = 0; i < _columnConfig.GetLength(0); i++)
        {
            sb.AppendFormat("<col style=\"width:{0}\" />", _columnConfig[i, 2].ToString());
        }
        sb.Append("</colgroup>");

        sb.Append("<thead>");
        sb.Append("<tr class=\"table-success\">");
        for (int i = 0; i < _columnConfig.GetLength(0); i++)
        {
            //if (mode != "xls" && _columnConfig[i, 4].ToString() == "Y")
            //{
            //    sb.AppendFormat("<th><a class=\"z-lnk-navy\" href=\"javascript:\" data-val=\"{0}\" onclick=\"_zw.fn.sort();\">{1} <i class=\"{2}\"</a></th>"
            //                     , _columnConfig[i, 0].ToString(), _columnConfig[i, 1].ToString()
            //                    , (ViewBag.R.lv.sort == _columnConfig[i, 0].ToString() ? (ViewBag.R.lv.sortdir == "ASC" ? "fe-arrow-up" : "fe-arrow-down") : ""));
            //}
            sb.AppendFormat("<th{0}>{1}</th>", sClassExcel, _columnConfig[i, 1].ToString());
        }
        sb.Append("</tr>");
        sb.Append("</thead>");
        return sb.ToString();
    }

    private string ViewList(string mode, DataSet data)
    {
        if (data != null && data.Tables.Count > 0)
        {
            string strID = "";
            string strValue = "";
            string strPadding = "";
            int iRow = 1;

            StringBuilder sb = new StringBuilder();
            sb.AppendFormat("<table class=\"table table-hover table-bordered table-sm\" style=\"width:{0}\">", this._tblWidth);
            sb.Append(RenderColumnHeader(mode));
            sb.Append("<tbody>");

            if (ViewBag.R.lv.cd1.ToString() == "A")
            {
                foreach (DataRow row in data.Tables[0].Rows)
                {
                    sb.Append("<tr>");

                    DataSet dsDoc = null;
                    using (ZumNet.DAL.InterfaceDac.InterfaceDac rpBiz = new ZumNet.DAL.InterfaceDac.InterfaceDac())
                    {
                        dsDoc = rpBiz.GetReport("", 0, ViewBag.R.ft.ToString(), "", "", row["ITEM_CODE"].ToString(), "", "", "", "");
                    }

                    for (int i = 0; i < _columnConfig.GetLength(0); i++)
                    {
                        strID = _columnConfig[i, 0].ToString();

                        if (strID.ToUpper() == "SEQ")
                        {
                            strValue = iRow.ToString();
                        }
                        else if (strID.ToUpper() == "__LINK1__")
                        {
                            if (dsDoc != null && dsDoc.Tables.Count > 0 && dsDoc.Tables[0].Rows.Count > 0)
                            {
                                strValue = RenderSubItem(mode, dsDoc.Tables[0].Rows, "관련도면등록서", "560", "144", "-60", "");
                            }
                            else strValue = "";
                        }
                        else if (strID.ToUpper() == "__LINK2__")
                        {
                            if (dsDoc != null && dsDoc.Tables.Count > 0 && dsDoc.Tables[1].Rows.Count > 0)
                            {
                                strValue = RenderSubItem(mode, dsDoc.Tables[1].Rows, "관련부품승인원", "560", "144", "-10", "");
                            }
                            else strValue = "";
                        }
                        else
                        {
                            strValue = row[strID].ToString();
                        }

                        if (strID == "ITEM_CODE")
                        {
                            if (row["PLAN_LEVEL"].ToString() == "") strPadding = "";
                            else strPadding = "margin-left:" + (Convert.ToInt16(row["PLAN_LEVEL"].ToString().Replace("_", "")) * 20).ToString() + "px";
                            sb.AppendFormat("<td class=\"{0}\"><div style=\"{2}\">{1}</div></td>", _columnConfig[i, 3].ToString() == "L" ? "text-left" : "text-center", strValue, strPadding);
                        }
                        else
                        {
                            sb.AppendFormat("<td class=\"{0}\">{1}</td>", _columnConfig[i, 3].ToString() == "L" ? "text-left" : "text-center", strValue);
                        }
                    }

                    sb.Append("</tr>");
                    iRow++;

                    if (dsDoc != null) { dsDoc.Dispose(); dsDoc = null; }
                }
            }
            else if (ViewBag.R.lv.cd1.ToString() == "B")
            {
                ViewBag.R.lv["total"] = iRow.ToString();
                sb.Append("<tr>");

                for (int i = 0; i < _columnConfig.GetLength(0); i++)
                {
                    strID = _columnConfig[i, 0].ToString();

                    if (strID.ToUpper() == "SEQ")
                    {
                        strValue = iRow.ToString();
                    }
                    else if (strID.ToUpper() == "ITEM_CODE")
                    {
                        strValue = ViewBag.R.lv.cd2.ToString();
                    }
                    else if (strID.ToUpper() == "ITEM_NAME")
                    {
                        strValue = ViewBag.R.lv.cd3.ToString();
                    }
                    else if (strID.ToUpper() == "__LINK1__")
                    {
                        if (data != null && data.Tables.Count > 0 && data.Tables[0].Rows.Count > 0)
                        {
                            strValue = RenderSubItem(mode, data.Tables[0].Rows, "관련도면등록서", "560", "144", "-60", "");
                        }
                        else strValue = "";
                    }
                    else if (strID.ToUpper() == "__LINK2__")
                    {
                        if (data != null && data.Tables.Count > 0 && data.Tables[1].Rows.Count > 0)
                        {
                            strValue = RenderSubItem(mode, data.Tables[1].Rows, "관련부품승인원", "560", "144", "-10", "");
                        }
                        else strValue = "";
                    }
                    else
                    {
                        strValue = "";
                    }
                    sb.AppendFormat("<td class=\"{0}\">{1}</td>", _columnConfig[i, 3].ToString() == "L" ? "text-left" : "text-center", strValue);
                }
                sb.Append("</tr>");
            }

            sb.Append("</tbody>");
            sb.Append("</table>");
            //dt = null;
            return sb.ToString();
        }
        return "";
    }

    private string RenderSubItem(string mode, DataRowCollection data, string dn, string width, string height, string left, string top)
    {
        StringBuilder sb = new StringBuilder();
        string strPreMsgId = "";
        string strFileIcon = "";
        int iCnt = 0;

        if (mode == "xls")
        {
            //2016-04-29 추가
            foreach (DataRow row in data)
            {
                if (strPreMsgId != row["MessageID"].ToString())
                {
                    sb.AppendFormat("<div style=\"text-align:left\">- {0}_V{1} ({2})</div>", row["PIName"].ToString(), row["MAINREVISION"].ToString(), row["DocNumber"].ToString());
                }
                strPreMsgId = row["MessageID"].ToString();
                iCnt++;
            }
        }
        else
        {
            sb.AppendFormat("<a class=\"z-lnk-navy\" href=\"javascript:\" onclick=\"_zw.fn.optionWnd('', {1}, {2}, {3}, {4});return false;\">{0}</a>", dn, width, height, left, top);
            sb.Append("<div style=\"display:none\"><table class=\"table table-striped table-sm mb-0\">");
            sb.Append("<colgroup><col width=\"32%\" /><col width=\"8%\" /><col width=\"60%\" /></colgroup>");
            sb.Append("<thead>");
            sb.Append("<tr><th>결재문서</th><th>버전</th><th>첨부파일</th></tr>");
            sb.Append("</thead>");
            sb.Append("<tbody>");
            foreach (DataRow row in data)
            {
                //if (row["FileType"].ToString().ToLower() == "dwg") strFileIcon = "small_" + row["FileType"].ToString().ToLower() + ".png";
                //else strFileIcon = "small_" + row["FileType"].ToString().ToLower() + ".gif";

                if (strPreMsgId != row["MessageID"].ToString())
                {
                    if (iCnt > 0) sb.Append("</td></tr>");
                    sb.AppendFormat("<tr><td><a class=\"z-lnk-navy\" href=\"javascript:\" onclick=\"_zw.fn.openEAFormSimple('{1}');\">{0}</a></td>", row["PIName"].ToString(), row["MessageID"].ToString());
                    sb.AppendFormat("<td>{0}</td>", row["MAINREVISION"].ToString());
                    sb.Append("<td>");
                }
                if (row["FileName"].ToString() == "") sb.Append("&nbsp;");
                else sb.AppendFormat("<div><a class=\"z-lnk-navy\" target=\"_blank\" href=\"/{0}/PortalService/FileDown.aspx?xf=ea&sn={1}\"><i class=\"{3} mr-1\"></i>{2}</a></div>", "BizForce", row["SavedName"].ToString(), row["FileName"].ToString(), ZumNet.Web.Bc.CommonUtils.GetFileExt(row["FileType"].ToString()));

                strPreMsgId = row["MessageID"].ToString();
                iCnt++;
            }
            sb.Append("</tbody>");
            sb.Append("</table></div>");
        }
        return sb.ToString();
    }

    private string ListCount()
    {
        string sPage = "";
        int totalCount = 0;
        if (ViewBag.R.ft.ToString() == "___")
        {
            int maxPage = ZumNet.Web.Bc.CommonUtils.IsMobile() ? 5 : 10;
            totalCount = Convert.ToInt32(ViewBag.R.lv.total.Value);
            int pageCount = Convert.ToInt32(ViewBag.R.lv.count.Value);
            int pageIndex = Convert.ToInt32(ViewBag.R.lv.page.Value);
            int totalPage = totalCount / pageCount;

            if (totalCount % pageCount > 0) { totalPage++; }
            if (pageIndex > totalPage) { pageIndex = totalPage; }

            sPage = String.Format("{0} {1} {2} ({3} / {4} {5})", Resources.Global.Total, totalCount.ToString(), Resources.Global.Count, pageIndex.ToString(), totalPage.ToString(), Resources.Global.Page);

        }
        else
        {
            totalCount = Convert.ToInt32(ViewBag.R.lv.total.Value);
            sPage = String.Format("{0} {1} {2}", Resources.Global.Total, totalCount.ToString(), Resources.Global.Count);
        }

        return sPage;
    }

    private string ListCond()
    {
        string sWidth = _columnConfig != null && _columnConfig.GetLength(0) > 0 ? " wd-md-70 wd-lg-55 wd-xl-45" : " wd-sm-80 wd-md-60 wd-lg-45 wd-xl-40";

        StringBuilder sb = new StringBuilder();

        sb.AppendFormat("<div class=\"z-list-cond d-flex justify-content-end wd-80{0}\">", sWidth);

        //sb.Append("<div class=\"z-list-date input-group datepicker input-daterange\">");
        //sb.AppendFormat("<input type=\"text\" class=\"form-control start-date px-1\" value=\"{0}\">", ViewBag.R.lv.start);
        //sb.Append("<div class=\"input-group-prepend\">");
        //sb.Append("<span class=\"input-group-text\">~</span>");
        //sb.Append("</div>");
        //sb.AppendFormat("<input type=\"text\" class=\"form-control end-date px-1\" value=\"{0}\">", ViewBag.R.lv.end);
        //sb.AppendFormat("<div class=\"input-group-append{0}\">", _columnConfig != null && _columnConfig.GetLength(0) > 0 ? "  d-flex d-sm-none" : "");
        //sb.Append("<button class=\"btn btn-secondary\" type=\"button\" data-zv-menu=\"search\"><i class=\"fe-search\"></i></button>");
        //sb.Append("</div>");
        //sb.Append("</div>");

        sb.Append("<div class=\"z-list-search input-group d-flex\">");
        sb.Append("<select class=\"custom-select ml-1\" id=\"_SearchSelect\" style=\"width: 140px\">");
        sb.AppendFormat("<option value=\"A\"{0}>{1}</option>", ViewBag.R.lv.cd1.ToString() == "A" ? " selected" : "", "모델번호");
        sb.AppendFormat("<option value=\"B\"{0}>{1}</option>", ViewBag.R.lv.cd1.ToString() == "B" ? " selected" : "", "부품번호");

        sb.Append("</select>");
        sb.AppendFormat("<input type=\"text\" class=\"form-control\" id=\"_SearchText\" readonly placeholder=\"{0}\" value=\"{1}\" />", Resources.Global.Search, ViewBag.R.lv.cd2.ToString());
        sb.AppendFormat("<input type=\"hidden\" id=\"_SearchCond3\" value=\"{0}\" />", ViewBag.R.lv.cd2.ToString());

        sb.Append("<span class=\"input-group-text border-0 pl-1\">");
        sb.Append("<button type=\"button\" class=\"btn btn-outline-secondary btn-18\" title=\"모델명\" onclick=\"_zw.fn.externalWnd('erp.items', 240, 40, 20, 70, '', '_SearchText', '_SearchCond3');\">");
        sb.Append("<i class=\"fas fa-angle-down\"></i>");
        sb.Append("</button>");
        sb.Append("</span>");

        sb.Append("<span class=\"input-group-append\">");
        sb.Append("<button class=\"btn btn-secondary\" type=\"button\" data-zv-menu=\"search\"><i class=\"fe-search\"></i></button>");
        sb.Append("</span>");
        sb.Append("</div>");

        sb.Append("</div>"); //z-list-cond
        return sb.ToString();
    }

    private void ExcelBind(string data)
    {
        string strExcelFileName = ViewBag.R.ft.ToString() + "_Export_" + DateTime.Now.ToString("yyMMdd_HHmmss") + ".xls"; //2014-04-11
        Response.Clear();
        Response.Charset = "utf-8";
        Response.Buffer = true;
        //EnableViewState = false;
        Response.AddHeader("content-disposition", "attachment;filename=" + strExcelFileName); //Content.xls");
        Response.ContentType = "application/x-msdownload";
        string encoding = Request.ContentEncoding.HeaderName;
        Response.Write("<html xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\" xmlns=\"http://www.w3.org/TR/REC-html40\"><head>");
        Response.Write("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=" + encoding + "\">");
        Response.Write("<style type=\"text/css\">" + ExcelStyle() + "</style>");
        Response.Write("</head>");
        Response.Write("<body>");
        Response.Write(data);
        Response.Write("</body></html>");
    }

    public string ExcelStyle()
    {
        return @"
body {width: 100%}
table {width: ; border-top: 0.1pt solid windowtext; border-right: 0.1pt solid windowtext}
td {border-bottom: 0.1pt solid windowtext; border-left: 0.1pt solid windowtext; padding: 4px;}

.xls_warning {background-color: #fcf8e3}
.xls_th {border-bottom: 0.1pt solid windowtext; border-left: 0.1pt solid windowtext; padding: 4px; text-align: center; background-color: #dff0d8}

.text-center {text-align: center}
.xl66 {mso-number-format:'\#\,\#\#0\.0000\;\[Red\]\\-\#\,\#\#0\.0000';}
.xl88 {mso-number-format:'\#\,\#\#0\.0000_\)\;\[Red\]\\\(\#\,\#\#0\.0000\\\)';}
";
    }
}
@if (svcRt != null && svcRt.ResultCode != 0)
{
    @Html.Partial("~/Views/Shared/_ErrorInline.cshtml", new HandleErrorInfo(new Exception(svcRt.ResultMessage), "Report", ViewBag.R.ttl.ToString()))
}
else
{
    <div class="z-list-head d-flex justify-content-between my-2">
        <div class="z-list-page d-flex align-items-center" id="__ListCount">
            <div class="z-list-total mt-1 mr-1">
                <i class="fe-chevron-right"></i> @ListCount()
            </div>
        </div>
        @Html.Raw(ListCond())
    </div>

    if (svcRt == null)
    {
        <div class="z-list-body" id="__ListView">
            @Html.Raw(ViewList(ViewBag.R.mode.ToString(), null))
        </div>
    }
    else
    {
        <div class="z-list-body" id="__ListView">
            @Html.Raw(ViewList(ViewBag.R.mode.ToString(), svcRt.ResultDataSet))
        </div>
    }

}