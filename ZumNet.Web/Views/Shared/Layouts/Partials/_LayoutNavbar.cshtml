@using System.Data;
@using System.Text;
@using System.Threading;
@using ZumNet.Framework.Web.MultiLang

@{
    bool hideToggle = ViewData["LayoutNavbarHideToggle"] != null && ViewData["LayoutNavbarHideToggle"].ToString() == "True";

    string[,] vLocale = { { "en-US", "English (US)" }, { "ko-KR", "한국어" }, { "zh-CN", "中文(简体)" }, { "ja-JP", "日本語" } };

    string sCurrentLocale = Thread.CurrentThread.CurrentUICulture.Name;
    //Response.Write("lang => " + sCurrentLocale);

    //Thread.CurrentThread.CurrentUICulture = System.Globalization.CultureInfo.GetCultureInfo(vLocale[2]);

    //Response.Write(Thread.CurrentThread.CurrentUICulture);

    //ZumNet.Framework.Log.Logging.WriteDebug(HttpContext.Current.Request.CurrentExecutionFilePath + " => " + DateTime.Now.ToString() + " : " + sCurrentLocale);

    string[] vOrganQuery = { "", "" };
    string[] vLinkSiteQuery = { "", "" };

    foreach (DataRow row in ViewBag.MainMenu.Rows)
    {
        if (row["Permission"].ToString() == "Y" && row["Position"].ToString() == "9")
        {
            if (row["CTAlias"].ToString() == "orgmap")
            {
                vOrganQuery[0] = row["DisplayName"].ToString();
                //vOrganQuery[1] = ZumNet.Framework.Util.SecurityHelper.ToBase64("{ct:\"" + row["CT_ID"].ToString() + "\",ctalias:\"" + row["CTAlias"].ToString() + "\",ttl:\"" + row["DisplayName"].ToString() + "\",opnode:\"0.0.12029\"}"); //링크사이트 ct, opennode 지정
                vOrganQuery[1] = Server.UrlEncode("{ct:\"" + row["CT_ID"].ToString() + "\",ctalias:\"" + row["CTAlias"].ToString() + "\",ttl:\"" + row["DisplayName"].ToString() + "\",opnode:\"0.0.12029\"}"); //링크사이트 ct, opennode 지정
            }
            else if (row["CTAlias"].ToString() == "linksite")
            {
                vLinkSiteQuery[0] = row["DisplayName"].ToString();
                //vLinkSiteQuery[1] = ZumNet.Framework.Util.SecurityHelper.ToBase64("{ct:\"" + row["CT_ID"].ToString() + "\",ctalias:\"" + row["CTAlias"].ToString() + "\",ttl:\"" + row["DisplayName"].ToString() + "\",opnode:\"0.0.12029\"}"); //링크사이트 ct, opennode 지정
                vLinkSiteQuery[1] = Server.UrlEncode("{ct:\"" + row["CT_ID"].ToString() + "\",ctalias:\"" + row["CTAlias"].ToString() + "\",ttl:\"" + row["DisplayName"].ToString() + "\",opnode:\"0.0.12029\"}"); //링크사이트 ct, opennode 지정
            }
        }
    }

    StringBuilder sb = new StringBuilder();
    if (ViewBag.LinkSite != null && ViewBag.LinkSite.Tables.Count > 0)
    {
        //string sQuery = ZumNet.Framework.Util.SecurityHelper.ToBase64("{ct:\"130\",ctalias:\"linksite\",ttl:\"링크사이트\",opnode:\"0.0.12029\"}"); //링크사이트 ct, opennode 지정

        //sb.Append("<div class=\"dropdown-menu dropdown-menu-right mt-0 py-0\" style=\"min-width: 26rem; width: 26rem\">");
        //sb.AppendFormat("<div class=\"bg-teal text-center py-1\"><a class=\"dropdown-item z-wave data-navmenu text-white\" href=\"/LinkSite?qi={0}\">{1}</a></div>", vLinkSiteQuery[1], vLinkSiteQuery[0]);
        sb.Append("<div class=\"list-group\">");

        Dictionary<string, string> dic = new Dictionary<string, string>(); //해시테이블 보다 형식을 규정해야 함

        foreach (DataRow row in ViewBag.LinkSite.Tables[0].Rows)
        {
            if (!dic.ContainsKey(row["FD_ID"].ToString()))
            {
                dic.Add(row["FD_ID"].ToString(), row["DisplayName"].ToString());
            }
        }

        foreach (string k in dic.Keys)
        {
            //Response.Write(k + " => " + dic[k].ToString() + "<br />");
            DataRow[] q = ViewBag.LinkSite.Tables[0].Select("FD_ID = " + k);

            if (q.Length > 0)
            {
                sb.Append("<div class=\"row mx-0\">");
                sb.AppendFormat("<div class=\"col-3 list-group-item list-group-item-action text-center border-bottom-1 border-light\">{0}</div>", dic[k].ToString());
                sb.Append("<div class=\"col-9 list-group-item list-group-item-action p-1\">");

                foreach (DataRow row in q)
                {
                    sb.AppendFormat("<a href=\"{0}\" target=\"_blank\" class=\"btn btn-sm rounded-pill btn-default m-0 ml-1 mb-1{1}\">{2}</a>", row["Url"].ToString(), (Convert.ToInt32(row["SortKey"]) < 3 ? " font-weight-bold" : ""), row["SiteName"].ToString());
                }

                sb.Append("</div>");
                sb.Append("</div>");
            }
        }

        sb.Append("</div>");
        //sb.Append("</div>");
    }
}

@functions {
    private string GetNavUserImage()
    {
        string imagepath = Server.MapPath("~/images/users/" + Session["LogonID"].ToString() + ".jpg");
        if (File.Exists(imagepath))
        {
            FileStream fs = new FileStream(imagepath, FileMode.Open);
            byte[] byData = new byte[fs.Length];
            fs.Read(byData, 0, byData.Length);
            fs.Close();

            var base64 = Convert.ToBase64String(byData);

            return String.Format("<img src=\"data:image/jpg;base64,{0}\" alt=\"User Image\" class=\"rounded-circle\" style=\"width: 30px; height: 30px\">", base64);
        }
        else
        {
            return "<span class=\"h2 fas fa-user-circle mr-2 mb-0 align-middle\"></span";
        }
    }
}

<!-- Layout navbar -->
<nav class="layout-navbar navbar navbar-expand-md align-items-lg-center bg-navbar-theme" id="layout-navbar">
    <!-- Brand -->
    <a href="/" class="navbar-brand app-brand d-lg-none">
        <span class="app-brand-logo">
            <img src="~/images/logo-sm.png" />
        </span>
        <span class="app-brand-text d-none d-sm-block font-weight-normal ml-2">
            <img src="~/images/logo-2-light.png" />
        </span>
    </a>

    @if (!hideToggle)
    {
        <!-- Sidenav toggle -->
        <div class="layout-sidenav-toggle navbar-nav align-items-lg-center mr-auto mr-lg-4">
            <a class="nav-item nav-link z-wave px-2" href="javascript:void(0)">
                <i class="fe-menu text-large align-middle"></i>
            </a>
        </div>
    }

    <a class="nav-link z-wave text-large text-white py-0 mr-2 d-block d-md-none" href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="@Resources.Global.Alarm" style="line-height: 56px;">
        <i class="fe-bell"></i>
        <span class="badge badge-pill badge-blue indicator mt-3">10</span>
    </a>

    <!-- Navbar toggle -->
    <button class="navbar-toggler z-wave" type="button" data-toggle="modal" data-target=".messages-sidebox">
        <i class="fe-menu text-large align-middle"></i>
    </button>

    <div class="navbar-collapse collapse" id="layout-navbar-collapse">
        <!-- Divider -->
        <hr class="d-md-none w-100 py-0">

        <ul class="navbar-nav align-items-lg-center ml-auto my-0">
            <li class="nav-item mr-md-3 d-flex align-items-center">
                <!-- Search -->
                <form class="app-search">
                    <div class="input-group">
                        <input type="search" class="form-control" placeholder="@Resources.Global.Search...">
                        <button type="submit" class="btn py-0"><i class="fe-search navbar-icon align-middle"></i></button>
                    </div>
                </form>
            </li>

            @*<li class="nav-item mr-lg-2">
                    <a class="nav-link z-wave text-large px-2" href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="근무상태">
                        <i class="mdi mdi-timer-sand"></i>
                    </a>
                </li>*@

            <li class="nav-item mr-md-2">
                <a class="nav-link z-wave text-large" href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="@Resources.Global.FindPhoneNum">
                    <i class="fe-phone"></i>
                </a>
            </li>

            @*<li class="nav-item mr-lg-2">
                    <a class="nav-link z-wave text-large" href="@Url.Action("Index", "Organ", new { Area = "", qi = @vOrganQuery[1] })" data-toggle="tooltip" data-placement="bottom" title="@vOrganQuery[0]">
                        <i class="mdi mdi-sitemap"></i>
                    </a>
                </li>*@

            <li class="nav-item dropdown mr-md-2">
                <a class="nav-link z-wave text-large dropdown-toggle hide-arrow" href="javascript:void(0)" data-toggle="dropdown" data-placement="bottom" title="@vLinkSiteQuery[0]">
                    <i class="fas fa-map-marker-alt noti-icon"></i>
                    @*<span>@ViewBag.LinkSite.Tables.Count</span>*@
                </a>
                @if (ViewBag.LinkSite != null && ViewBag.LinkSite.Tables.Count > 0)
                {
                    <div class="dropdown-menu dropdown-menu-right mt-0 py-0" style="min-width: 26rem; width: 26rem">
                        <div class="bg-teal text-center py-1"><a class="dropdown-item z-wave data-navmenu text-white" href="/LinkSite?qi=@vLinkSiteQuery[1]">@vLinkSiteQuery[0]</a></div>
                        @Html.Raw(sb.ToString())
                    </div>
                }
            </li>

            <li class="nav-item dropdown mr-md-2">
                <a class="nav-link z-wave text-large dropdown-toggle hide-arrow" href="javascript:void(0)" data-toggle="dropdown" data-placement="bottom" title="@Resources.Global.Shortcut">
                    <i class="fe-navigation"></i>
                    @*<span>@ViewBag.ShoutLnk.Count.ToString(),  @(ViewBag.DeptList != null ? ViewBag.DeptList.Count.ToString() : "")</span>*@
                </a>
                @if (@ViewBag.ShortLink != null && ViewBag.ShortLink.Count > 0)
                {
                    <div class="dropdown-menu dropdown-menu-right mt-0 py-0">
                        <div class="bg-teal text-center text-white py-2">@Resources.Global.Shortcut</div>
                        <div class="list-group list-group-flush">
                            @foreach (DataRow row in ViewBag.ShortLink)
                            {
                                <a class="dropdown-item list-group-item list-group-item-action" href="javascript:void(0)" data-navmenu="@row["CTAlias"]">
                                    @if (row["CTAlias"].ToString() == "edm.new")
                                    {
                                        <i class="fe-file-text"></i>
                                    }
                                    else if (row["CTAlias"].ToString() == "ea.newdoc")
                                    {
                                        <i class="fe-edit"></i>
                                    }
                                    else
                                    {
                                        <i class="fe-edit"></i>
                                    }
                                    &nbsp;@row["DisplayName"]
                                </a>
                            }
                        </div>
                    </div>
                }
            </li>

            <li class="nav-item mr-md-2">
                <a class="nav-link z-wave text-large pr-3" href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="@Resources.Global.Alarm">
                    <i class="fe-bell"></i>
                    <span class="badge badge-pill badge-blue indicator mt-3">10</span>
                </a>
            </li>

            <li class="nav-item dropdown">
                <a class="nav-link z-wave text-large dropdown-toggle hide-arrow" href="javascript:void(0)" data-toggle="dropdown" data-placement="bottom" title="@Resources.Global.LangSet">
                    @*<i class="fe-navigation"></i>*@
                    <span class="btn btn-indigo btn-sm px-1" style="width: 28px">@sCurrentLocale.Substring(0, 2).ToUpper()</span>
                </a>
                <div class="dropdown-menu dropdown-menu-right mt-0 py-0">
                    <div class="list-group list-group-flush">

                        @for (int i = 0; i < vLocale.GetLength(0); i++)
                        {
                            if (vLocale[i, 0].Contains(sCurrentLocale))
                            {
                                <a class="dropdown-item list-group-item list-group-item-action disabled" href="javascript:void(0)" data-navmenu="locale" data-navval="@vLocale[i, 0]">@vLocale[i, 1]</a>
                            }
                            else
                            {
                                <a class="dropdown-item list-group-item list-group-item-action" href="javascript:void(0)" data-navmenu="locale" data-navval="@vLocale[i, 0]">@vLocale[i, 1]</a>
                            }
                        }
                    </div>
                </div>
            </li>

            <li class="nav-item d-none d-lg-block text-big font-weight-light line-height-1 opacity-50 mr-2 ml-1">|</li>

            <li class="nav-item dropdown">
                <a class="nav-link z-wave dropdown-toggle" href="javascript:void(0)" data-toggle="dropdown">
                    @Html.Raw(GetNavUserImage())
                    <span class="px-0 mr-lg-0 ml-2 ml-lg-1">@Session["URName"]</span>
                </a>
                <div class="dropdown-menu dropdown-menu-right mt-0">
                    <a class="dropdown-item" href="javascript:void(0)"><i class="fe-user mr-2"></i>@Resources.Global.MyInfo</a>
                    <a class="dropdown-item" href="javascript:void(0)"><i class="fe-clock mr-2"></i>@Resources.Global.WorkCond</a>
                    <a class="dropdown-item" href="@Url.Action("Index", "Organ", new { Area = "", qi = @vOrganQuery[1] })"><i class="fe-users mr-2"></i>@vOrganQuery[0]</a>
                    <div class="dropdown-divider"></div>
                    @if (Session["WoA"].ToString() == "sysadmin" || Session["WoA"].ToString() == "dnadmin") //fas fa-tools, fe-wifi
                    {
                        <a class="dropdown-item" href="/WoA/Dashboard"><i class="fe-settings mr-2"></i>@Resources.Global.AdminTool</a>
                    }
                    else if (Session["WoA"].ToString() == "orgadmin")
                    {
                        <a class="dropdown-item" href="/WoA/Organ"><i class="fe-settings mr-2"></i>@Resources.Global.OrganMgr</a>
                    }
                    <a class="dropdown-item" href="/Account/Logout"><i class="fe-power mr-2 text-danger"></i>@Resources.Global.Logout</a>
                </div>
            </li>
        </ul>
    </div>
</nav>

<div id="layout-navbar-rightbar" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-right" role="document">
        <div class="modal-content">
            <div class="modal-header bg-light" style="box-shadow: 0 1px 1px rgb(50 58 70 / 10%);">
                <div class="d-flex justify-content-start">
                    <div class="mr-3">@Html.Raw(GetNavUserImage())</div>
                    <div class="h5 mb-0 mt-2 mr-1">@Session["URName"]</div>
                    <div class="h6 mb-0 mt-2 font-weight-normal d-none d-sm-block">(@Session["LogonID"])</div>
                </div>
                @*<div class="h5 mb-0 mt-2">@Session["URName"] <span class="h6 font-weight-normal d-none d-sm-inline-block">(@Session["LogonID"])</span></div>*@

                <div class="align-self-end">
                    @if (Session["WoA"].ToString() == "sysadmin" || Session["WoA"].ToString() == "dnadmin") //fas fa-tools, fe-wifi
                    {
                        <a class="text-large mr-3" href="/WoA/Dashboard" data-toggle="tooltip" data-placement="bottom" title="@Resources.Global.AdminTool"><i class="fe-settings"></i></a>
                    }
                    else if (Session["WoA"].ToString() == "orgadmin")
                    {
                        <a class="text-large mr-3" href="/WoA/Organ" data-toggle="tooltip" data-placement="bottom" title="@Resources.Global.OrganMgr"><i class="fe-settings"></i></a>
                    }
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-2">
                <div class="input-group">
                    <input type="search" class="form-control" placeholder="Search...">
                    <button type="submit" class="btn py-0"><i class="fe-search navbar-icon align-middle"></i></button>
                </div>

                <div class="d-flex justify-content-between mt-2">
                    <a class="btn text-large" href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="@Resources.Global.MyInfo"><i class="fe-user"></i></a>
                    <a class="btn text-large" href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="@Resources.Global.WorkCond"><i class="fe-clock"></i></a>
                    <a class="btn text-large" href="@Url.Action("Index", "Organ", new { Area = "", qi = @vOrganQuery[1] })" data-toggle="tooltip" data-placement="bottom" title="@vOrganQuery[0]"><i class="fe-users"></i></a>



                    <a class="btn text-large text-warning" href="/Account/Logout" data-toggle="tooltip" data-placement="bottom" title="@Resources.Global.Logout"><i class="fe-power"></i></a>
                </div>

                <div class="dropdown-divider"></div>

                <div class="d-flex justify-content-between">
                    <a class="btn text-large" href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="@Resources.Global.FindPhoneNum"><i class="fe-phone"></i></a>

                    <a class="linksite-toggler btn text-large" href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="@vLinkSiteQuery[0]">
                        <i class="fas fa-map-marker-alt noti-icon"></i>
                    </a>

                    <div class="dropdown">
                        <a class="btn text-large dropdown-toggle hide-arrow" href="javascript:void(0)" data-toggle="dropdown" data-placement="bottom" title="@Resources.Global.Shortcut">
                            <i class="fe-navigation"></i>
                        </a>
                        @if (@ViewBag.ShortLink != null && ViewBag.ShortLink.Count > 0)
                        {
                            <div class="dropdown-menu dropdown-menu-right mt-0 py-0">
                                <div class="bg-teal text-center text-white py-2">@Resources.Global.Shortcut</div>
                                <div class="list-group list-group-flush">
                                    @foreach (DataRow row in ViewBag.ShortLink)
                                    {
                                        <a class="dropdown-item list-group-item list-group-item-action" href="javascript:void(0)" data-navmenu="@row["CTAlias"]">
                                            @if (row["CTAlias"].ToString() == "edm.new")
                                            {
                                                <i class="fe-file-text"></i>
                                            }
                                            else if (row["CTAlias"].ToString() == "ea.newdoc")
                                            {
                                                <i class="fe-edit"></i>
                                            }
                                            else
                                            {
                                                <i class="fe-edit"></i>
                                            }
                                            &nbsp;@row["DisplayName"]
                                        </a>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <div class="dropdown">
                        <a class="btn text-large dropdown-toggle hide-arrow" href="javascript:void(0)" data-toggle="dropdown" data-placement="bottom" title="@Resources.Global.LangSet">
                            <span class="btn btn-indigo btn-sm px-1">@sCurrentLocale.Substring(0, 2).ToUpper()</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right mt-0 py-0">
                            <div class="list-group list-group-flush">

                                @for (int i = 0; i < vLocale.GetLength(0); i++)
                                {
                                    if (vLocale[i, 0].Contains(sCurrentLocale))
                                    {
                                        <a class="dropdown-item list-group-item list-group-item-action disabled" href="javascript:void(0)" data-navmenu="locale" data-navval="@vLocale[i, 0]">@vLocale[i, 1]</a>
                                    }
                                    else
                                    {
                                        <a class="dropdown-item list-group-item list-group-item-action" href="javascript:void(0)" data-navmenu="locale" data-navval="@vLocale[i, 0]">@vLocale[i, 1]</a>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="__linkSite" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="z-index: 1091 !important">
    <div class="modal-dialog modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><a class="z-wave data-navmenu text-primary" href="/LinkSite?qi=@vLinkSiteQuery[1]">@vLinkSiteQuery[0]</a></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-3">
                @Html.Raw(sb.ToString())
            </div>
        </div>
    </div>
</div>

<form id="fmExternal" method="post" action="" class="d-none">
    <input type="hidden" id="auth_external" name="auth_external" value="@Session["LogonID"]" />
    <input type="hidden" id="current_culture" name="auth_external" value="@sCurrentLocale" />
</form>
<!-- / Layout navbar -->
