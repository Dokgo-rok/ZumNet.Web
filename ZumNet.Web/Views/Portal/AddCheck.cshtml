@using System.Text;
@{
    //Model["WorkStatus"] = "A";
    ViewBag.Title = Resources.Global.GotoWork;

    if (Model["WorkStatus"] == "A" || Model["WorkStatus"] == "Z")
    {
    }
    else if (Model["PwdChange"] == "Y")
    {
        ViewBag.Title = Resources.Global.Password_Change;
    }
    Layout = "~/Views/Shared/Layouts/_LayoutBlank.cshtml";

    //Response.Write("WorkStatus => " + Model["PwdChange"]);

    //Model["WorkStatus"] = "_";
    //Model["PwdChange"] = "Y";
}
@section Styles {
    @Styles.Render("~/bundle/vendor/css/pages/authentication")

    <style type="text/css">
        .card {
            border-radius: 1.5rem !important;
            -webkit-box-flex: 0;
            -ms-flex: 0 0 320px;
            flex: 0 0 320px;
            max-width: 320px;
            border: .5rem solid #ccc;
        }

        .card-header {
            /*border-top-left-radius: 1rem !important;
            border-top-right-radius: 1rem !important;*/
            font-size: .9rem;
        }

        .ccircle {
            width: 180px;
            border-radius: 50%;
            border: 1rem solid #26AAE1;
            font-size: 1.5rem;
            letter-spacing: 0px;
            line-height: 8rem;
        }

        .vl {
            border-left: 2px solid #e2e2e2;
        }

        h3 {
            margin-bottom: 0;
            color: #878787;
        }
    </style>
}

<div class="authentication-wrapper authentication-1 px-4 bg-light">
    <div class="authentication-inner">

        @if (Model["WorkStatus"] == "A" || Model["WorkStatus"] == "Z")
        {
            <div id="__ClockIn" class="card">
                <div class="m-2 card-header d-flex justify-content-between p-2 border-secondary">
                    <div class="pt-1"><i class="fas fa-angle-right"></i> @Resources.Global.WorkCond</div>
                    <div class="btn btn-secondary text-white font-weight-bold text-big py-1" id="lblClock">@DateTime.Now.ToString("HH:mm:ss")</div>
                </div>
                <div class="card-body p-2">
                    <div class="row d-flex">
                        @if (Model["InTime"] == "")
                        {
                            <div class="col-6 flex-fill text-center">
                                <h5 class="text-windows"><i class="mdi mdi-clock-time-nine-outline"></i><span class="ml-1"> @Resources.Global.PlanWorktTime</span></h5>
                                <p class="text-muted text-big">@DateTime.Now.ToShortDateString()</p>
                                <h3>@Convert.ToDateTime(Model["PlanInTime"]).ToLongTimeString()</h3>
                            </div>
                        }
                        else
                        {
                            <div class="col-6 flex-fill text-center">
                                <h5 class="text-windows"><i class="mdi mdi-clock-time-nine-outline"></i><span class="ml-1"> @Resources.Global.WorktTime</span></h5>
                                <p class="text-muted text-big">@DateTime.Now.ToShortDateString()</p>
                                <h3>@Convert.ToDateTime(Model["InTime"]).ToLongTimeString()</h3>
                            </div>
                        }

                        @if (Model["OutTime"] == "")
                        {
                            <div class="col-6 flex-fill text-center vl">
                                <h5 class="" style="color: rgb(255, 117, 16)"><i class="mdi mdi-clock-time-five-outline"></i><span class="ml-1"> @Resources.Global.PlanLeaveTime</span></h5>
                                <p class="text-muted text-big">@DateTime.Now.ToShortDateString()</p>
                                <h3>@Convert.ToDateTime(Model["PlanOutTime"]).ToLongTimeString()</h3>
                            </div>
                        }
                        else
                        {
                            <div class="col-6 flex-fill text-center vl">
                                <h5 class="" style="color: rgb(255, 117, 16)"><i class="mdi mdi-clock-time-five-outline"></i><span class="ml-1"> @Resources.Global.LeaveTime</span></h5>
                                <p class="text-muted text-big">@DateTime.Now.ToShortDateString()</p>
                                <h3>@Convert.ToDateTime(Model["OutTime"]).ToLongTimeString()</h3>
                            </div>
                        }
                    </div>

                    <div class="col-12 my-4 text-center">
                        @if (Model["WorkStatus"] == "Z")
                        {
                            <button class="btn btn-outline-windows ccircle" data-menu="checkWorkTime">@Resources.Global.OffWorkCancel</button>
                        }
                        else
                        {
                            <button class="btn btn-outline-windows ccircle" data-menu="checkWorkTime">@Resources.Global.GotoWork</button>
                        }
                    </div>

                    <div class="text-center px-2 my-2">
                        <button class="btn btn-outline-windows btn-block font-weight-bold text-big" data-menu="skipNext">@Resources.Global.Skip</button>
                    </div>
                </div>
            </div>
        }

        @if (Model["PwdChange"] == "Y")
        {
            <div id="__PwdChange" class="@((Model["WorkStatus"] == "A" || Model["WorkStatus"] == "Z") ? "d-none" : "")">
                <div class="mb-3">
                    <div class="h3 text-primary">@Resources.Global.Password_Change</div>
                </div>

                <!-- Form -->
                <div>
                    <div class="form-group mb-2">
                        <div class="input-group">
                            @Html.Password("Password", "", new { @class = "form-control", placeholder = @Resources.Global.Password_Current })
                            @Html.ValidationMessage("Password", "", new { @class = "text-danger" })
                            <div class="input-group-append" data-password="false"><span class="input-group-text fas fa-eye password-eye bg-light"></span></div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="input-group">
                            @Html.Password("NewPassword", "", new { @class = "form-control", placeholder = @Resources.Global.Password_New })
                            @Html.ValidationMessage("NewPassword", "", new { @class = "text-danger" })
                            <div class="input-group-append" data-password="false"><span class="input-group-text fas fa-eye password-eye bg-light"></span></div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="input-group">
                            @Html.Password("NewPassword2", "", new { @class = "form-control", placeholder = @Resources.Global.Password_Confirm })
                            @Html.ValidationMessage("NewPassword2", "", new { @class = "text-danger" })
                            <div class="input-group-append" data-password="false"><span class="input-group-text fas fa-eye password-eye bg-light"></span></div>
                        </div>
                    </div>

                    <div class="form-group mb-2">
                        <ul class="mb-0 text-danger">
                            <li>암호는 영문,숫자,특수문자 포함 8자~20자로 입력하여야 합니다.</li>
                            <li>변경 사항이 적용되면 다시 로그온 합니다.</li>
                        </ul>
                    </div>

                    <div class="form-group text-center">
                        <button class="btn btn-primary btn-block" data-menu="changePwd">@Resources.Global.Confirm</button>
                    </div>
                </div>
                <!-- / Form -->
            </div>
        }

    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        $(function () {
            var workTimeStatus = "@Model["WorkStatus"]";
            var passwordChange = "@Model["PwdChange"]";
            var returnUrl = "@ViewBag.ReturnUrl";

            var userLogonId = "@Session["LogonID"]";
            var userId = "@Session["URID"]";

            $("[data-password]").on('click', function () {
                if ($(this).attr('data-password') == "false") {
                    $(this).siblings("input").attr("type", "text");
                    $(this).attr('data-password', 'true');
                    $(this).addClass("show-password");
                } else {
                    $(this).siblings("input").attr("type", "password");
                    $(this).attr('data-password', 'false');
                    $(this).removeClass("show-password");
                }
            });

            $('#NewPassword2').keyup(function (e) {
                if (e.which == 13) $('.btn[data-menu="changePwd"]').click();
            });

            $('.btn[data-menu]').on('click', function () {

                if ($(this).attr('data-menu') == "checkWorkTime") {
                    //bootbox.alert($(this).attr('data-menu')); return;

                    $.ajax({
                        type: "POST",
                        url: "/ExS/WorkTime/StatusEvent",
                        data: '{ss:"' + (workTimeStatus == 'Z' ? 'N' : 'A') + '"}',
                        success: function (res) {
                            if (res.substr(0, 2) == "OK") $('.btn[data-menu="skipNext"]').click();
                            else bootbox.alert(res);
                        }
                    });

                } else if ($(this).attr('data-menu') == "skipNext") {
                    $('#__ClockIn').hide();

                    if (passwordChange == 'Y') {
                        window.document.title = "@Resources.Global.Password_Change";
                        $('#__PwdChange').removeClass('d-none');
                    } else window.location.href = '/'; //returnUrl != '' ? returnUrl : '/';

                } else if ($(this).attr('data-menu') == "changePwd") {
                    var curPwd = $('#Password'), newPwd = $('#NewPassword'), cfmPwd = $('#NewPassword2');

                    if ($.trim(curPwd.val()) == '') {
                        bootbox.alert('현재 비밀번호 누락!', function () { curPwd.focus(); }); return false;
                    }

                    var rt = _zw.ut.checkPwd(userLogonId, newPwd.val(), 8, 20, 3);
                    if (rt != '') {
                        bootbox.alert(rt, function () { newPwd.focus(); }); return false;
                    }

                    if (newPwd.val() != cfmPwd.val()) {
                        bootbox.alert('비밀번호가 일치하지 않습니다!', function () { cfmPwd.focus(); }); return false;
                    }

                    $.ajax({
                        type: "POST",
                        url: "/Env/PwdChange",
                        data: '{urid:"' + userId + '",logonid:"' + userLogonId + '",cur:"' + curPwd.val() + '",new:"' + newPwd.val() + '",cfm:"' + cfmPwd.val() + '"}',
                        success: function (res) {
                            if (res.substr(0, 2) == "OK") {
                                if (res == 'OK') bootbox.alert('설정됐습니다!', function () { window.location.href = '/Account/Logout'; });
                                else bootbox.alert('타시스템 비밀번호 변경 오류!<br />' + res.substr(2), function () { window.location.href = '/Account/Logout'; }); //ekp 비밀번호 변경 성공

                            } else bootbox.alert(res);
                        },
                        beforeSend: function () { _zw.ut.ajaxLoader(true, 'Processing...'); }
                    });
                }
            });
        });
    </script>

    @if (Model["WorkStatus"] == "A" || Model["WorkStatus"] == "Z")
    {
        <script type="text/javascript">
            $(function () {

                var clock = function () {
                    $('#lblClock').html(moment().format('HH:mm:ss'));
                }

                setInterval(clock, 1000);
            });
        </script>
    }
}